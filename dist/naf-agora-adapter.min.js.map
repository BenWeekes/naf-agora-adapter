{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","AgoraRtcAdapter","constructor","easyrtc","console","log","this","window","app","room","userid","appid","mocapData","mocapPrevData","logi","logo","mediaStreams","remoteClients","occupantList","audioJitter","pendingMediaRequests","Map","enableVideo","enableVideoFiltered","enableAudio","enableAvatar","remoteAudioTrack","localTracks","videoTrack","audioTrack","musicTrack","token","clientId","uid","vbg","vbg0","showLocal","virtualBackgroundInstance","extension","processor","pipeProcessor","track","pipe","processorDestination","serverTimeRequests","timeOffsets","avgTimeOffset","agoraClient","syncObjects","agoraRTM","agoraRTM2","rtmClient","rtmUid","rtmChannelName","rtmChannel","setPeerOpenListener","clientConnection","getPeerConnectionByUserId","setPeerClosedListener","isChrome","navigator","userAgent","indexOf","oldRTCPeerConnection","RTCPeerConnection","Proxy","construct","target","args","length","push","encodedInsertableStreams","oldSetConfiguration","setConfiguration","arguments","apply","CustomDataDetector","CustomDatLengthByteCount","senderChannel","MessageChannel","receiverChannel","_vad_audioTrack","_voiceActivityDetectionFrequency","_vad_MaxAudioSamples","_vad_MaxBackgroundNoiseLevel","_vad_SilenceOffeset","_vad_audioSamplesArr","_vad_audioSamplesArrSorted","_vad_exceedCount","_vad_exceedCountThreshold","_vad_exceedCountThresholdLow","_voiceActivityDetectionInterval","setServerUrl","url","setSocketUrl","setApp","appName","json","replace","obj","JSON","parse","AgoraRTC","loadModule","SegPlugin","joinRoom","setWebRtcOptions","options","video","audio","enableDataChannels","datachannel","enableVideoReceive","enableAudioReceive","setServerConnectListeners","successListener","failureListener","connectSuccess","connectFailure","setRoomOccupantListener","occupantListener","roomName","occupants","primary","setDataChannelListeners","openListener","closedListener","messageListener","setDataChannelOpenListener","setDataChannelCloseListener","setPeerListener","updateTimeOffset","clientSentTime","Date","now","fetch","document","location","href","method","cache","then","res","serverReceivedTime","headers","getTime","precision","clientReceivedTime","timeOffset","reduce","acc","offset","setTimeout","connect","Promise","all","resolve","reject","generateId","connectAgora","_connect","_","_myRoomJoinTime","_getRoomJoinTime","catch","shouldStartConnectionTo","client","roomJoinTime","startStreamConnection","error","caller","media","NAF","write","errorCode","errorText","wasAccepted","closeStreamConnection","info","hangup","sendMocap","mocap","port1","postMessage","watermark","sender","streams","createEncodedStreams","textEncoder","TextEncoder","that","transformer","TransformStream","transform","chunk","controller","data","v","byteLength","encode","frame","Uint8Array","set","bytes","getIntBytes","magicIndex","charCodeAt","buffer","y","warn","enqueue","readable","pipeThrough","pipeTo","writable","worker","Worker","onmessage","event","senderTransform","RTCRtpScriptTransform","port","port2","e","receiver","textDecoder","TextDecoder","view","DataView","magicData","magic","String","fromCharCode","mocapLen","getUint32","frameSize","mocapBuffer","decode","remoteMocap","ArrayBuffer","receiverTransform","_users","u","_mediaStreamTrack","_p2pChannel","connection","peerConnection","getStats","async","stats","forEach","report","type","kind","jitterBufferDelay","toFixed","isNaN","handleRTM","senderId","text","dataType","handleRTM2","msg","message","sendData","sendDataGuaranteed","destinationClientId","sendAgoraRTM","broadcastDataGuaranteed","broadcastData","stringify","payload","publishMessage","publish","sendMessage","destination","targetRoom","sendDataWS","getConnectStatus","adapters","IS_CONNECTED","status","NOT_CONNECTED","CONNECTING","getMediaStream","streamName","has","audioPromise","promise","videoPromise","streamPromise","setMediaStream","stream","clientMediaStreams","audioTracks","getAudioTracks","audioStream","MediaStream","addTrack","videoTracks","getVideoTracks","videoStream","x","addLocalMediaStream","id","register3rdPartyLocalMediaStream","keys","addStreamToCall","removeLocalMediaStream","closeLocalMediaStream","enableMicrophone","enabled","enableCamera","disconnect","user","mediaType","handleUserUnpublished","getInputLevel","analyser","_source","volumeLevelAnalyser","analyserNode","bufferLength","frequencyBinCount","getByteFrequencyData","values","Math","floor","result","characters","charactersLength","counter","charAt","random","voiceActivityDetection","_enabled","audioLevel","removed","shift","removedIndex","splice","sort","a","b","_state_stop_at","stop","unpublish","path","volume","createBufferSourceAudioTrack","source","encoderConfig","bitrate","stereo","setVolume","play","startProcessAudioBuffer","cycle","createCustomAudioTrack","mediaStreamTrack","success","failure","createClient","codec","setParameter","setInterval","readStats","setClientRole","on","copy","subscribe","querySelector","srcObject","enc_id","receivers","getReceivers","createDecoder","getElementById","captureStream","join","createMicrophoneAudioTrack","createCustomVideoTrack","createCameraVideoTrack","audio_track","gum_stream","cams","getCameras","label","deviceId","setDevice","imgElement","createElement","onload","inject","setOptions","enable","background","src","VirtualBackgroundExtension","registerExtensions","createProcessor","init","color","senders","getSenders","createEncoder","AgoraRTM","setArea","areaCodes","RTM","presenceTimeout","addEventListener","eventArgs","publisher","presence","eventType","snapshot","present","userId","logout","login","createInstance","logFilter","LOG_FILTER_OFF","newState","reason","createChannel","memberId","myRoomId","getRoomOccupantsAsMap","getServerTime","register"],"mappings":"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","file":"naf-agora-adapter.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","class AgoraRtcAdapter {\n\n  constructor(easyrtc) {\n\n    console.log(\"BW73 constructor \", easyrtc);\n\n    this.easyrtc = easyrtc || window.easyrtc;\n    this.app = \"default\";\n    this.room = \"default\";\n    this.userid = 0;\n    this.appid = null;\n    this.mocapData = \"\";\n    this.mocapPrevData = \"\";\n    this.logi = 0;\n    this.logo = 0;\n    this.mediaStreams = {};\n    this.remoteClients = {};\n    this.occupantList = {};\n    this.audioJitter = {};\n    this.pendingMediaRequests = new Map();\n    this.enableVideo = false;\n    this.enableVideoFiltered = false;\n    this.enableAudio = false;\n    this.enableAvatar = false;\n    this.remoteAudioTrack = null;\n\n    this.localTracks = { videoTrack: null, audioTrack: null, musicTrack: null };\n    window.localTracks = this.localTracks;\n    this.token = null;\n    this.clientId = null;\n    this.uid = null;\n    this.vbg = false;\n    this.vbg0 = false;\n    this.showLocal = false;\n    this.virtualBackgroundInstance = null;\n    this.extension = null;\n    this.processor = null;\n    this.pipeProcessor = (track, processor) => {\n      track.pipe(processor).pipe(track.processorDestination);\n    }\n\n    this.serverTimeRequests = 0;\n    this.timeOffsets = [];\n    this.avgTimeOffset = 0;\n    this.agoraClient = null;\n\n    // RTM\n    this.syncObjects = true;\n    this.agoraRTM = false;\n    this.agoraRTM2 = false;\n    this.rtmClient = null;\n    this.rtmUid = null;\n    this.rtmChannelName = null;\n    this.rtmChannel = null;\n\n    if (this.easyrtc) {\n      this.easyrtc.setPeerOpenListener(clientId => {\n        const clientConnection = this.easyrtc.getPeerConnectionByUserId(clientId);\n        this.remoteClients[clientId] = clientConnection;\n      });\n\n      this.easyrtc.setPeerClosedListener(clientId => {\n        delete this.remoteClients[clientId];\n      });\n    }\n\n    this.isChrome = (navigator.userAgent.indexOf('Firefox') === -1 && navigator.userAgent.indexOf('Chrome') > -1);\n\n    if (this.isChrome) {\n      window.oldRTCPeerConnection = RTCPeerConnection;\n      window.RTCPeerConnection = new Proxy(window.RTCPeerConnection, {\n        construct: function (target, args) {\n          if (args.length > 0) {\n            args[0][\"encodedInsertableStreams\"] = true;\n          } else {\n            args.push({ encodedInsertableStreams: true });\n          }\n\n          const pc = new window.oldRTCPeerConnection(...args);\n          return pc;\n        },\n      });\n      const oldSetConfiguration = window.RTCPeerConnection.prototype.setConfiguration;\n      window.RTCPeerConnection.prototype.setConfiguration = function () {\n        const args = arguments;\n        if (args.length > 0) {\n          args[0][\"encodedInsertableStreams\"] = true;\n        } else {\n          args.push({ encodedInsertableStreams: true });\n        }\n\n        oldSetConfiguration.apply(this, args);\n      };\n    }\n\n    // custom data append params\n    this.CustomDataDetector = 'AGORAMOCAP';\n    this.CustomDatLengthByteCount = 4;\n    this.senderChannel = new MessageChannel;\n    this.receiverChannel;\n    //this.r_receiver=null;\n    //this.r_clientId=null;\n\n    this._vad_audioTrack = null;\n    this._voiceActivityDetectionFrequency = 150;\n\n    this._vad_MaxAudioSamples = 400;\n    this._vad_MaxBackgroundNoiseLevel = 20;\n    this._vad_SilenceOffeset = 4;\n    this._vad_audioSamplesArr = [];\n    this._vad_audioSamplesArrSorted = [];\n    this._vad_exceedCount = 0;\n    this._vad_exceedCountThreshold = 2;\n    this._vad_exceedCountThresholdLow = 1;\n    this._voiceActivityDetectionInterval;\n    window.AgoraRtcAdapter = this;\n\n  }\n\n  setServerUrl(url) {\n    console.log(\"BW73 setServerUrl \", url);\n    if (this.easyrtc) {\n      this.easyrtc.setSocketUrl(url);\n    }\n  }\n\n  setApp(appName) {\n    console.log(\"BW73 setApp \", appName);\n    this.app = appName;\n    this.appid = appName;\n  }\n\n  async setRoom(json) {\n    json = json.replace(/'/g, '\"');\n    const obj = JSON.parse(json);\n    this.room = obj.name;\n\n    if (obj.vbg && obj.vbg == 'true') {\n      this.vbg = true;\n    }\n\n    if (obj.vbg0 && obj.vbg0 == 'true') {\n      this.vbg0 = true;\n      AgoraRTC.loadModule(SegPlugin, {});\n    }\n\n    if (obj.enableAvatar && obj.enableAvatar == 'true') {\n      this.enableAvatar = true;\n    }\n\n    if (obj.syncObjects && obj.syncObjects == 'false') {\n      this.syncObjects = false;\n    }\n\n    if (obj.agoraRTM && obj.agoraRTM == 'true') {\n      this.agoraRTM = true;\n    }\n\n\n    if (obj.agoraRTM2 && obj.agoraRTM2 == 'true') {\n      this.agoraRTM2 = true;\n    }\n\n    if (obj.showLocal && obj.showLocal == 'true') {\n      this.showLocal = true;\n    }\n\n    if (obj.enableVideoFiltered && obj.enableVideoFiltered == 'true') {\n      this.enableVideoFiltered = true;\n    }\n    if (!this.agoraRTM) {\n      this.easyrtc.joinRoom(this.room, null);\n    }\n  }\n\n  // options: { datachannel: bool, audio: bool, video: bool }\n  setWebRtcOptions(options) {\n  // using Agora\n    this.enableVideo = options.video;\n    this.enableAudio = options.audio;\n\n    if (!this.easyrtc){\n      return;\n    }\n    console.log(\"BW73 setWebRtcOptions \", options);\n    // this.easyrtc.enableDebug(true);\n    this.easyrtc.enableDataChannels(options.datachannel);\n    // not easyrtc\n    this.easyrtc.enableVideo(false);\n    this.easyrtc.enableAudio(false);\n    this.easyrtc.enableVideoReceive(false);\n    this.easyrtc.enableAudioReceive(false);\n  }\n\n  setServerConnectListeners(successListener, failureListener) {\n    console.log(\"BW73 setServerConnectListeners \", successListener, failureListener);\n    this.connectSuccess = successListener;\n    this.connectFailure = failureListener;\n  }\n\n  setRoomOccupantListener(occupantListener) {\n    console.log(\"BW73 setRoomOccupantListener \", occupantListener);\n    this.occupantListener=occupantListener;\n\n    if (!this.easyrtc){\n      return;\n    }\n    this.easyrtc.setRoomOccupantListener(function (roomName, occupants, primary) {\n      occupantListener(occupants);\n    });\n  }\n\n  setDataChannelListeners(openListener, closedListener, messageListener) {\n    console.log(\"BW73 setDataChannelListeners  \", openListener, closedListener, messageListener);\n\n\n    this.openListener = openListener;\n    this.messageListener = messageListener;\n    this.closedListener = closedListener;    \n    if (!this.easyrtc){\n      return;\n    }\n    this.easyrtc.setDataChannelOpenListener(openListener);\n    this.easyrtc.setDataChannelCloseListener(closedListener);\n    this.easyrtc.setPeerListener(messageListener);\n  }\n\n  updateTimeOffset() {\n    console.log(\"BW73 updateTimeOffset \");\n    const clientSentTime = Date.now() + this.avgTimeOffset;\n\n    return fetch(document.location.href, { method: \"HEAD\", cache: \"no-cache\" }).then(res => {\n      var precision = 1000;\n      var serverReceivedTime = new Date(res.headers.get(\"Date\")).getTime() + precision / 2;\n      var clientReceivedTime = Date.now();\n      var serverTime = serverReceivedTime + (clientReceivedTime - clientSentTime) / 2;\n      var timeOffset = serverTime - clientReceivedTime;\n\n      this.serverTimeRequests++;\n\n      if (this.serverTimeRequests <= 10) {\n        this.timeOffsets.push(timeOffset);\n      } else {\n        this.timeOffsets[this.serverTimeRequests % 10] = timeOffset;\n      }\n\n      this.avgTimeOffset = this.timeOffsets.reduce((acc, offset) => acc += offset, 0) / this.timeOffsets.length;\n\n      if (this.serverTimeRequests > 10) {\n        setTimeout(() => this.updateTimeOffset(), 5 * 60 * 1000); // Sync clock every 5 minutes.\n      } else {\n        this.updateTimeOffset();\n      }\n    });\n  }\n\n  connect() {\n\n    console.log(\"BW73 connect\");\n    Promise.all([this.updateTimeOffset(), new Promise((resolve, reject) => {\n      if (this.agoraRTM) {\n        this.clientId=this.generateId(10);\n        this.connectAgora(resolve, reject); //resolve, reject);\n      } else {\n        this._connect(resolve, reject);\n      }\n    })]).then(([_, clientId]) => {\n      console.log(\"BW73 connected \" + clientId);\n      this.clientId = clientId;\n      if (!this.agoraRTM) {\n        this._myRoomJoinTime = this._getRoomJoinTime(clientId);\n        this.connectAgora();\n      }\n      this.connectSuccess(clientId);\n    }).catch(this.connectFailure);\n  }\n\n  shouldStartConnectionTo(client) {\n    return this._myRoomJoinTime <= client.roomJoinTime;\n  }\n\n  startStreamConnection(clientId) {\n    if (!this.easyrtc){\n      return;\n    }\n    console.error(\"BW73 startStreamConnection \", clientId);\n    this.easyrtc.call(clientId, function (caller, media) {\n      if (media === \"datachannel\") {\n        NAF.log.write(\"Successfully started datachannel to \", caller);\n      }\n    }, function (errorCode, errorText) {\n      NAF.log.error(errorCode, errorText);\n    }, function (wasAccepted) {\n      // console.log(\"was accepted=\" + wasAccepted);\n    });\n  }\n\n  closeStreamConnection(clientId) {\n    console.info(\"BW73 closeStreamConnection \", clientId);\n    if (this.agoraRTM) {\n      this.closedListener(clientId);  \n    } else {\n      this.easyrtc.hangup(clientId);\n    }    \n  }\n\n\n\n  sendMocap(mocap) {\n    if (mocap == this.mocapPrevData) {\n      //   console.log(\"blank\");\n      mocap = \"\";\n    }\n\n    // set to blank after sending\n    if (this.mocapData === \"\") {\n      this.mocapData = mocap;\n    }\n\n    if (!this.isChrome) {\n      this.senderChannel.port1.postMessage({ watermark: mocap });\n    }\n  }\n\n  async createEncoder(sender) {\n    if (this.isChrome) {\n      const streams = sender.createEncodedStreams();\n      const textEncoder = new TextEncoder();\n      var that = this;\n      const transformer = new TransformStream({\n        transform(chunk, controller) {\n          let d=chunk.data;\n          let v=chunk.data.byteLength;\n          const mocap = textEncoder.encode(that.mocapData);\n          //    console.error(\"appending \",that.mocapData);\n          that.mocapPrevData = that.mocapData;\n          that.mocapData = \"\";\n          const frame = chunk.data;\n          const data = new Uint8Array(chunk.data.byteLength + mocap.byteLength + that.CustomDatLengthByteCount + that.CustomDataDetector.length);\n          data.set(new Uint8Array(frame), 0);\n          data.set(mocap, frame.byteLength);\n          var bytes = that.getIntBytes(mocap.byteLength);\n          for (let i = 0; i < that.CustomDatLengthByteCount; i++) {\n            data[frame.byteLength + mocap.byteLength + i] = bytes[i];\n          }\n\n          // Set magic string at the end\n          const magicIndex = frame.byteLength + mocap.byteLength + that.CustomDatLengthByteCount;\n          for (let i = 0; i < that.CustomDataDetector.length; i++) {\n            data[magicIndex + i] = that.CustomDataDetector.charCodeAt(i);\n          }\n          chunk.data = data.buffer;\n          let y=chunk.data.byteLength;\n          if (y>=1000) {\n            console.warn('audio frame too large, skipping... ',v,y,y-v, that.mocapPrevData);\n            chunk.data=d;\n          } \n         // console.warn(v,y,y-v);\n         // console.warn(v,y,y-v);\n          controller.enqueue(chunk);\n        }\n      });\n\n      streams.readable.pipeThrough(transformer).pipeTo(streams.writable);\n    } else {\n      var that = this;\n      const worker = new Worker('./dist/script-transform-worker.js');\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'registered') {\n          resolve();\n        }\n      });\n      const senderTransform = new RTCRtpScriptTransform(worker, { name: 'outgoing', port: that.senderChannel.port2 }, [that.senderChannel.port2]);\n      senderTransform.port = that.senderChannel.port1;\n      sender.transform = senderTransform;\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'started') {\n          resolve();\n        }\n      });\n\n      senderTransform.port.onmessage = e => {\n        if (e.data == \"CLEAR\") {\n          that.mocapPrevData = that.mocapData;\n          that.mocapData = \"\";\n        }\n      };\n      that.senderChannel.port1.postMessage({ watermark: that.mocapData });\n    }\n  }\n\n\n  async createDecoder(receiver, clientId) {\n    if (this.isChrome) {\n      const streams = receiver.createEncodedStreams();\n      const textDecoder = new TextDecoder();\n      var that = this;\n\n      const transformer = new TransformStream({\n        transform(chunk, controller) {\n            if (chunk.data.byteLength - that.CustomDataDetector.length>0) {\n            const view = new DataView(chunk.data);\n            const magicData = new Uint8Array(chunk.data, chunk.data.byteLength - that.CustomDataDetector.length, that.CustomDataDetector.length);\n            let magic = [];\n            for (let i = 0; i < that.CustomDataDetector.length; i++) {\n              magic.push(magicData[i]);\n\n            }\n            let magicString = String.fromCharCode(...magic);\n            if (magicString === that.CustomDataDetector) {\n              const mocapLen = view.getUint32(chunk.data.byteLength - (that.CustomDatLengthByteCount + that.CustomDataDetector.length), false);\n              const frameSize = chunk.data.byteLength - (mocapLen + that.CustomDatLengthByteCount + that.CustomDataDetector.length);\n              const mocapBuffer = new Uint8Array(chunk.data, frameSize, mocapLen);\n              const mocap = textDecoder.decode(mocapBuffer)\n              if (mocap.length > 0) {\n                window.remoteMocap(mocap + \",\" + clientId);\n              }\n              const frame = chunk.data;\n              chunk.data = new ArrayBuffer(frameSize);\n              const data = new Uint8Array(chunk.data);\n              data.set(new Uint8Array(frame, 0, frameSize));\n            }\n          }\n          controller.enqueue(chunk);\n        }\n      });\n      streams.readable.pipeThrough(transformer).pipeTo(streams.writable);\n    } else {\n      this.receiverChannel = new MessageChannel;\n      var that = this;\n     // const worker = new Worker('/dist/script-transform-worker.js');\n      const worker = new Worker('./dist/script-transform-worker.js');\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'registered') {\n\n          resolve();\n        }\n      });\n\n      const receiverTransform = new RTCRtpScriptTransform(worker, { name: 'incoming', port: that.receiverChannel.port2 }, [that.receiverChannel.port2]);\n\n      receiverTransform.port = that.receiverChannel.port1;\n      receiver.transform = receiverTransform;\n      receiverTransform.port.onmessage = e => {\n        if (e.data.length > 0) {\n          window.remoteMocap(e.data + \",\" + clientId);\n        }\n      };\n\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'started') {\n          resolve();\n        }\n      });\n    }\n  }\n\n  async readStats() {\n    if (!this.agoraClient._users) {\n      return;\n    }\n    for (var u = 0; u < this.agoraClient._users.length; u++) {\n      if (this.agoraClient._users[u].audioTrack && this.agoraClient._users[u].audioTrack._mediaStreamTrack) {\n        await this.agoraClient._p2pChannel.connection.peerConnection.getStats(this.agoraClient._users[u].audioTrack._mediaStreamTrack).then(async stats => {\n          await stats.forEach(report => {\n            if (report.type === \"inbound-rtp\" && report.kind === \"audio\") {\n              var jitterBufferDelay = (report[\"jitterBufferDelay\"] / report[\"jitterBufferEmittedCount\"]).toFixed(3);\n              if (!isNaN(jitterBufferDelay)) {\n                this.audioJitter[this.agoraClient._users[u].uid] = jitterBufferDelay * 1000;\n              } else {\n                this.audioJitter[this.agoraClient._users[u].uid] = 80; // default ms\n              }\n            }\n          })\n        });\n      }\n    }\n  }\n\n  handleRTM(senderId, text) {\n    const data = JSON.parse(text);\n    console.log(\"BW75 handleRTM\", senderId, data);\n    //console.error('messageListener 2', window.AgoraRtcAdapter.messageListener);\n    window.AgoraRtcAdapter.messageListener(senderId, data.dataType, data.data);\n  }\n\n  handleRTM2(senderId, text) {\n    const msg = JSON.parse(text);\n    const data = JSON.parse(msg.message);\n    //console.warn(\"BW75 handleRTM2\", senderId, data.dataType, data.data);\n    //console.error('messageListener 2', window.AgoraRtcAdapter.messageListener);\n    window.AgoraRtcAdapter.messageListener(senderId, data.dataType, data.data);\n  }\n\n  sendData(clientId, dataType, data) {\n    console.log(\"BW75 sendData \", clientId, dataType, data);\n    return sendDataGuaranteed(clientId, dataType, data);\n  }\n\n  sendDataGuaranteed(destinationClientId, dataType, data) {\n    if (this.agoraRTM) {\n        this.sendAgoraRTM(dataType, data);      \n    } else {\n       this.broadcastDataGuaranteed(dataType, data);\n    }\n  }\n\n  broadcastData(dataType, data) {\n    return this.broadcastDataGuaranteed(dataType, data);\n  }\n\n  async sendAgoraRTM(dataType, data) {\n    if (!this.syncObjects) {\n      return;\n    }\n   // console.warn('sending Agora RTM',dataType, data);\n    let msg = JSON.stringify({ dataType: dataType, data: data });\n    if (this.agoraRTM2) {\n      if (this.rtmClient != null) {   \n        const payload = { type: \"text\", message: msg };\n        const publishMessage = JSON.stringify(payload);\n        try {\n          await this.rtmClient.publish(\n            this.room,\n            publishMessage\n          );\n        } catch (error) {\n          console.log(error);\n        }\n      } else {\n        //console.error(\"unable to send message RTM2 \",dataType,data);\n      }\n    } else {\n      if (this.rtmChannel != null) {   \n        this.rtmChannel.sendMessage({ text: msg }).then(() => {\n          console.log(\"BW75 broadcastDataGuaranteed sent \", dataType, data);\n        }).catch(error => {\n          console.error('AgoraRTM send failure for rtmChannel', error);\n        });\n      } else {\n        //console.error(\"unable to send message RTM1 \",dataType,data);\n      }\n    }\n  }\n\n  broadcastDataGuaranteed(dataType, data) {\n    if (this.agoraRTM) {\n        this.sendAgoraRTM(dataType, data);\n    } else {\n        var destination = { targetRoom: this.room };\n        this.easyrtc.sendDataWS(destination, dataType, data); \n    }\n  }\n\n  getConnectStatus(clientId) {\n    if (!this.easyrtc){\n      //console.trace();\n      return  NAF.adapters.IS_CONNECTED;\n    }\n    var status = this.easyrtc.getConnectStatus(clientId);\n\n    if (status == this.easyrtc.IS_CONNECTED) {\n      return NAF.adapters.IS_CONNECTED;\n    } else if (status == this.easyrtc.NOT_CONNECTED) {\n      return NAF.adapters.NOT_CONNECTED;\n    } else {\n      return NAF.adapters.CONNECTING;\n    }\n  }\n\n  getMediaStream(clientId, streamName = \"audio\") {\n    console.log(\"BW73 getMediaStream \", clientId, streamName);\n    if (this.mediaStreams[clientId] && this.mediaStreams[clientId][streamName]) {\n      NAF.log.write(`Already had ${streamName} for ${clientId}`);\n      return Promise.resolve(this.mediaStreams[clientId][streamName]);\n    } else {\n      NAF.log.write(`Waiting on ${streamName} for ${clientId}`);\n\n      // Create initial pendingMediaRequests with audio|video alias\n      if (!this.pendingMediaRequests.has(clientId)) {\n        const pendingMediaRequests = {};\n\n        const audioPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.audio = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Audio Error`, e));\n\n        pendingMediaRequests.audio.promise = audioPromise;\n\n        const videoPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.video = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Video Error`, e));\n        pendingMediaRequests.video.promise = videoPromise;\n\n        this.pendingMediaRequests.set(clientId, pendingMediaRequests);\n      }\n\n      const pendingMediaRequests = this.pendingMediaRequests.get(clientId);\n\n      // Create initial pendingMediaRequests with streamName\n      if (!pendingMediaRequests[streamName]) {\n        const streamPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests[streamName] = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream \"${streamName}\" Error`, e));\n        pendingMediaRequests[streamName].promise = streamPromise;\n      }\n\n      return this.pendingMediaRequests.get(clientId)[streamName].promise;\n    }\n  }\n\n  setMediaStream(clientId, stream, streamName) {\n    console.log(\"BW73 setMediaStream \", clientId, stream, streamName);\n    const pendingMediaRequests = this.pendingMediaRequests.get(clientId); // return undefined if there is no entry in the Map\n    const clientMediaStreams = this.mediaStreams[clientId] = this.mediaStreams[clientId] || {};\n\n    if (streamName === 'default') {\n      // Safari doesn't like it when you use a mixed media stream where one of the tracks is inactive, so we\n      // split the tracks into two streams.\n      // Add mediaStreams audio streamName alias\n      const audioTracks = stream.getAudioTracks();\n      if (audioTracks.length > 0) {\n        const audioStream = new MediaStream();\n        try {\n          audioTracks.forEach(track => audioStream.addTrack(track));\n          clientMediaStreams.audio = audioStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"audio\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream audio alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      // Add mediaStreams video streamName alias\n      const videoTracks = stream.getVideoTracks();\n      if (videoTracks.length > 0) {\n        const videoStream = new MediaStream();\n        try {\n          videoTracks.forEach(track => videoStream.addTrack(track));\n          clientMediaStreams.video = videoStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"video\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream video alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n      }\n    } else {\n      clientMediaStreams[streamName] = stream;\n\n      // Resolve the promise for the user's media stream by StreamName if it exists.\n      if (pendingMediaRequests && pendingMediaRequests[streamName]) {\n        pendingMediaRequests[streamName].resolve(stream);\n      }\n    }\n  }\n\n  getIntBytes(x) {\n    var bytes = [];\n    var i = this.CustomDatLengthByteCount;\n    do {\n      bytes[--i] = x & (255);\n      x = x >> 8;\n    } while (i)\n    return bytes;\n  }\n\n  addLocalMediaStream(stream, streamName) {\n    if (!this.easyrtc){\n      return;\n    }\n    console.log(\"BW73 addLocalMediaStream \", stream, streamName);\n    const easyrtc = this.easyrtc;\n    streamName = streamName || stream.id;\n    this.setMediaStream(\"local\", stream, streamName);\n    easyrtc.register3rdPartyLocalMediaStream(stream, streamName);\n\n    // Add local stream to existing connections\n    Object.keys(this.remoteClients).forEach(clientId => {\n      if (easyrtc.getConnectStatus(clientId) !== easyrtc.NOT_CONNECTED) {\n        easyrtc.addStreamToCall(clientId, streamName);\n      }\n    });\n  }\n\n  removeLocalMediaStream(streamName) {\n    delete this.mediaStreams[\"local\"][streamName];\n    if (!this.easyrtc){\n      return;\n    }\n    console.log(\"BW73 removeLocalMediaStream \", streamName);\n    this.easyrtc.closeLocalMediaStream(streamName);\n\n  }\n\n  enableMicrophone(enabled) {\n    if (!this.easyrtc){\n      return;\n    }\n    this.easyrtc.enableMicrophone(enabled);\n  }\n\n  enableCamera(enabled) {\n    if (!this.easyrtc){\n      return;\n    }\n    this.easyrtc.enableCamera(enabled);\n  }\n\n  disconnect() {\n    if (!this.easyrtc){\n      return;\n    }\n    this.easyrtc.disconnect();\n  }\n\n  async handleUserPublished(user, mediaType) { }\n\n  handleUserUnpublished(user, mediaType) {\n    console.log(\"BW73 handleUserUnPublished \");\n  }\n\n  getInputLevel(track) {\n    var analyser = track._source.volumeLevelAnalyser.analyserNode;\n    //var analyser = track._source.analyserNode;\n    const bufferLength = analyser.frequencyBinCount;\n    var data = new Uint8Array(bufferLength);\n    analyser.getByteFrequencyData(data);\n    var values = 0;\n    var average;\n    var length = data.length;\n    for (var i = 0; i < length; i++) {\n      values += data[i];\n    }\n    average = Math.floor(values / length);\n    return average;\n  }\n\n   generateId(length) {\n    let result = '';\n    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    const charactersLength = characters.length;\n    let counter = 0;\n    while (counter < length) {\n      result += characters.charAt(Math.floor(Math.random() * charactersLength));\n      counter += 1;\n    }\n    return result;\n}\n\n  voiceActivityDetection() {\n    if (!this._vad_audioTrack || !this._vad_audioTrack._enabled)\n      return;\n\n    var audioLevel = this.getInputLevel(this._vad_audioTrack);\n    if (audioLevel <= this._vad_MaxBackgroundNoiseLevel) {\n      if (this._vad_audioSamplesArr.length >= this._vad_MaxAudioSamples) {\n        var removed = this._vad_audioSamplesArr.shift();\n        var removedIndex = this._vad_audioSamplesArrSorted.indexOf(removed);\n        if (removedIndex > -1) {\n          this._vad_audioSamplesArrSorted.splice(removedIndex, 1);\n        }\n      }\n      this._vad_audioSamplesArr.push(audioLevel);\n      this._vad_audioSamplesArrSorted.push(audioLevel);\n      this._vad_audioSamplesArrSorted.sort((a, b) => a - b);\n    }\n    var background = Math.floor(3 * this._vad_audioSamplesArrSorted[Math.floor(this._vad_audioSamplesArrSorted.length / 2)] / 2);\n    if (audioLevel > background + this._vad_SilenceOffeset) {\n      this._vad_exceedCount++;\n    } else {\n      this._vad_exceedCount = 0;\n    }\n\n\n    if (this._vad_exceedCount > this._vad_exceedCountThresholdLow) {\n       window._state_stop_at = Date.now();\n    }\n\n    if (this._vad_exceedCount > this._vad_exceedCountThreshold) {\n      //AgoraRTCUtilEvents.emit(\"VoiceActivityDetected\", this._vad_exceedCount);\n      this._vad_exceedCount = 0;\n      window._state_stop_at = Date.now();\n      //   console.error(\"VAD \",Date.now()-window._state_stop_at);\n    }\n  }\n\n    async stopMusic() {\n      if (this.localTracks.musicTrack) {\n        this.localTracks.musicTrack.stop();\n        await this.agoraClient.unpublish(this.localTracks.musicTrack);\n      }\n    }\n\n    async stopTrack() {\n      if (this.localTracks.musicTrack) {\n        this.localTracks.musicTrack.stop();\n        await this.agoraClient.unpublish(this.localTracks.musicTrack);\n      }\n    }\n\n    async playMusic(path,volume) {\n      if (this.localTracks.musicTrack) {\n        this.localTracks.musicTrack.stop();\n        await this.agoraClient.unpublish(this.localTracks.musicTrack);\n      }\n      this.localTracks.musicTrack = await AgoraRTC.createBufferSourceAudioTrack({\n        source: path, encoderConfig: { bitrate:110, stereo:true}\n      });\n      this.localTracks.musicTrack.setVolume(volume);\n      await this.agoraClient.publish(this.localTracks.musicTrack);\n      this.localTracks.musicTrack.play();\n      this.localTracks.musicTrack.startProcessAudioBuffer({ cycle: 1 });\n    }\n\n\n    async playTrack(track,volume) {\n      if (this.localTracks.musicTrack) {\n        this.localTracks.musicTrack.stop();\n        await this.agoraClient.unpublish(this.localTracks.musicTrack);\n      }\n      this.localTracks.musicTrack = await AgoraRTC.createCustomAudioTrack({\n        mediaStreamTrack: track\n      });\n      this.localTracks.musicTrack.setVolume(volume);\n      await this.agoraClient.publish(this.localTracks.musicTrack);\n      //this.localTracks.musicTrack.play();\n    }\n\n\n  async connectAgora(success, failure) {\n    // Add an event listener to play remote tracks when remote user publishes.\n    var that = this;\n\n    this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    AgoraRTC.setParameter('SYNC_GROUP', false);\n    //    AgoraRTC.setParameter('SUBSCRIBE_TWCC', true);\n    setInterval(() => {\n      this.readStats();\n    }, 1000);\n\n\n    if (this.enableVideoFiltered || this.enableVideo || this.enableAudio) {\n      this.agoraClient.setClientRole(\"host\");\n    } \n\n    this.agoraClient.on(\"user-joined\", async (user) => {\n      if (this.agoraRTM && !this.agoraRTM2) {\n        console.info(\"user-joined\", user.uid, this.occupantList);\n        this.occupantList[user.uid]=user.uid;\n        let copy= JSON.parse(JSON.stringify(this.occupantList));\n        this.occupantListener(copy);\n      }\n    });\n    this.agoraClient.on(\"user-left\", async (user) => {   \n      if (this.agoraRTM && !this.agoraRTM2) {   \n        console.info(\"user-left\", user.uid, this.occupantList);\n        delete this.occupantList[user.uid];\n        let copy= JSON.parse(JSON.stringify(this.occupantList));\n        this.occupantListener(copy);\n      }\n    });\n    \n    this.agoraClient.on(\"user-published\", async (user, mediaType) => {\n\n      let clientId = user.uid;\n      console.log(\"BW73 handleUserPublished \" + clientId + \" \" + mediaType, that.agoraClient);\n      await that.agoraClient.subscribe(user, mediaType);\n      console.log(\"BW73 handleUserPublished2 \" + clientId + \" \" + that.agoraClient);\n\n      const pendingMediaRequests = that.pendingMediaRequests.get(clientId);\n      const clientMediaStreams = that.mediaStreams[clientId] = that.mediaStreams[clientId] || {};\n\n      if (mediaType === 'audio') {\n        //if (navigator.platform.indexOf('iPad')>-1 || navigator.platform.indexOf('iPhone')>-1)\n        //{ // too quiet\n        //          console.log(\"iOS play speaker\");\n          user.audioTrack.play();\n          that.remoteAudioTrack=user.audioTrack;\n        //      }\n\n        const audioStream = new MediaStream();\n        console.log(\"user.audioTrack \", user.audioTrack._mediaStreamTrack);\n        audioStream.addTrack(user.audioTrack._mediaStreamTrack);\n        clientMediaStreams.audio = audioStream;\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      let videoStream = null;\n      if (mediaType === 'video') {\n        videoStream = new MediaStream();\n        console.log(\"user.videoTrack \", user.videoTrack._mediaStreamTrack);\n        videoStream.addTrack(user.videoTrack._mediaStreamTrack);\n        clientMediaStreams.video = videoStream;\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n        //user.videoTrack\n      }\n\n      if (clientId == 'CCC') {\n        if (mediaType === 'video') {\n          document.querySelector(\"#video360\").srcObject = videoStream;\n          document.querySelector(\"#video360\").play();\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n      if (clientId == 'DDD') {\n        if (mediaType === 'video') {\n          user.videoTrack.play(\"video360\");\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n\n\n      let enc_id = 'na';\n      if (mediaType === 'audio') {\n        enc_id = user.audioTrack._mediaStreamTrack.id;\n      } else {\n        // enc_id=user.videoTrack._mediaStreamTrack.id;\n      }\n\n      const pc = this.agoraClient._p2pChannel.connection.peerConnection;\n      const receivers = pc.getReceivers();\n      for (let i = 0; i < receivers.length; i++) {\n        if (receivers[i].track && receivers[i].track.id === enc_id) {\n          //console.warn(\"Match\", mediaType, enc_id);\n          //          this.r_receiver=receivers[i];\n          //this.r_clientId=clientId;\n          this.createDecoder(receivers[i], clientId);\n        }\n      }\n    });\n\n    this.agoraClient.on(\"user-unpublished\", that.handleUserUnpublished);\n\n    console.log(\"connect agora \" + this.clientId);\n    // Join a channel and create local tracks. Best practice is to use Promise.all and run them concurrently.\n    // o\n\n    if (this.enableAvatar) {\n      var stream = document.getElementById(\"canvas\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideoFiltered && this.enableAudio) {\n      var stream = document.getElementById(\"canvas_secret\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideo && this.enableAudio) {\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCameraVideoTrack({ encoderConfig: '480p_2' })]);\n    } else if (this.enableVideo) {\n      [this.userid, this.localTracks.videoTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createCameraVideoTrack(\"360p_4\")]);\n    } else if (this.enableAudio) {\n      let audio_track;\n      if (window.gum_stream) { // avoid double allow iOs\n       // audio_track = AgoraRTC.createCustomAudioTrack({ mediaStreamTrack: window.gum_stream.getAudioTracks()[0],  encoderConfig: { bitrate:180, stereo:false} });\n       audio_track = AgoraRTC.createCustomAudioTrack({ mediaStreamTrack: window.gum_stream.getAudioTracks()[0],  encoderConfig: { bitrate:180, stereo:false} });\n        //console.warn(audio_track, \"audio_track\");\n      }\n      else {\n        //audio_track = AgoraRTC.createMicrophoneAudioTrack({encoderConfig: {bitrate:128, stereo:true}})\n        audio_track = AgoraRTC.createMicrophoneAudioTrack();\n      }\n\n      [this.userid, this.localTracks.audioTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), audio_track]);\n      //console.log(\"createMicrophoneAudioTrack\");\n      this._vad_audioTrack = this.localTracks.audioTrack;\n      if (!this._voiceActivityDetectionInterval) {\n        this._voiceActivityDetectionInterval = setInterval(() => {\n          this.voiceActivityDetection();\n        }, this._voiceActivityDetectionFrequency);\n      }\n    } else {\n      this.userid = await this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null);\n    }\n\n    // select facetime camera if exists\n    if (this.enableVideo && !this.enableVideoFiltered) {\n      let cams = await AgoraRTC.getCameras();\n      for (var i = 0; i < cams.length; i++) {\n        if (cams[i].label.indexOf(\"FaceTime\") == 0) {\n          console.log(\"select FaceTime camera\", cams[i].deviceId);\n          await this.localTracks.videoTrack.setDevice(cams[i].deviceId);\n        }\n      }\n    }\n\n    if (this.enableVideo && this.showLocal) {\n      this.localTracks.videoTrack.play(\"local-player\");\n    }\n\n    // Enable virtual background OLD Method\n    if (this.enableVideo && this.vbg0 && this.localTracks.videoTrack) {\n      const imgElement = document.createElement('img');\n      imgElement.onload = async () => {\n        if (!this.virtualBackgroundInstance) {\n          console.log(\"SEG INIT \", this.localTracks.videoTrack);\n          this.virtualBackgroundInstance = await SegPlugin.inject(this.localTracks.videoTrack, \"/assets/wasms0\").catch(console.error);\n          console.log(\"SEG INITED\");\n        }\n        this.virtualBackgroundInstance.setOptions({ enable: true, background: imgElement });\n      };\n      imgElement.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAAD0lEQVR4XmNg+M+AQDg5AOk9C/VkomzYAAAAAElFTkSuQmCC';\n    }\n\n    // Enable virtual background New Method\n    if (this.enableVideo && this.vbg && this.localTracks.videoTrack) {\n\n      this.extension = new VirtualBackgroundExtension();\n      AgoraRTC.registerExtensions([this.extension]);\n      this.processor = this.extension.createProcessor();\n      await this.processor.init(\"/assets/wasms\");\n      this.localTracks.videoTrack.pipe(this.processor).pipe(this.localTracks.videoTrack.processorDestination);\n      await this.processor.setOptions({ type: 'color', color: \"#00ff00\" });\n      await this.processor.enable();\n    }\n\n    window.localTracks = this.localTracks;\n\n    // Publish the local video and audio tracks to the channel.\n    if (this.enableVideo || this.enableAudio || this.enableAvatar) {\n      if (this.localTracks.audioTrack)\n        await this.agoraClient.publish(this.localTracks.audioTrack);\n      if (this.localTracks.videoTrack)\n        await this.agoraClient.publish(this.localTracks.videoTrack);\n\n      console.log(\"publish success\");\n      const pc = this.agoraClient._p2pChannel.connection.peerConnection;\n      const senders = pc.getSenders();\n      let i = 0;\n      for (i = 0; i < senders.length; i++) {\n        if (senders[i].track && (senders[i].track.kind == 'audio')) {\n          this.createEncoder(senders[i]);\n        }\n      }\n    }\n\n    // RTM\n    if (this.agoraRTM) {\n      if (this.clientId == null) {\n        this.clientId = 'X' + this.userid;\n      }\n      this.rtmUid = this.clientId;\n      if (!this.syncObjects){\n          return;\n      }\n      if (this.agoraRTM2) { // 2.x RTM\n        AgoraRTM.setArea({ areaCodes: [\"GLOBAL\"] });        \n        this.rtmClient = new AgoraRTM.RTM(this.appid, this.rtmUid, {presenceTimeout: 5}); \n        this.rtmClient.addEventListener({          \n          message: (eventArgs) => { // Message event handler\n            window.AgoraRtcAdapter.handleRTM2(eventArgs.publisher, eventArgs.message);            \n          },          \n          presence: (eventArgs) => { // Presence event handler\n            if (eventArgs.eventType === \"SNAPSHOT\") {\n                for (let u=0; u<eventArgs.snapshot.length; u++){\n                  let present=this.occupantList[eventArgs.snapshot[u].userId];\n                  this.occupantList[eventArgs.snapshot[u].userId]=eventArgs.snapshot[u].userId;\n                  let copy= JSON.parse(JSON.stringify(this.occupantList));\n                  this.occupantListener(copy);\n                  if (!present){\n                   // console.warn(\"openListener\",eventArgs.snapshot[u].userId);\n                    this.openListener(eventArgs.snapshot[u].userId);\n                  }\n                }\n            } else if (eventArgs.eventType === \"REMOTE_JOIN\") {\n                  let present=this.occupantList[eventArgs.publisher];\n                  this.occupantList[eventArgs.publisher]=eventArgs.publisher;\n                  let copy= JSON.parse(JSON.stringify(this.occupantList));\n                  this.occupantListener(copy);\n                  if (!present){\n                   // console.warn(\"openListener\",eventArgs.publisher);\n                    this.openListener(eventArgs.publisher);\n                  }\n            } else if (eventArgs.eventType === \"REMOTE_TIMEOUT\" || eventArgs.eventType === \"REMOTE_LEAVE\") {\n                  delete this.occupantList[eventArgs.publisher];\n                  let copy= JSON.parse(JSON.stringify(this.occupantList));\n                  this.occupantListener(copy);              \n            } \n          },\n        });\n\n        window.addEventListener(\"beforeunload\", () =>{\n          window.AgoraRtcAdapter.rtmClient.logout();\n        });\n\n        try {\n            const result = await this.rtmClient.login();\n            await this.rtmClient.subscribe(this.room);\n            console.log('rtm LOGIN SUCCESS for: '+ this.rtmUid,result);\n            success(this.clientId);\n        } catch (status) {\n            console.error('rtm LOGIN FAILED for: '+ this.rtmUid, status);\n        }\n      } else {  // rtm 1\n        this.rtmClient = AgoraRTM.createInstance(this.appid, { logFilter: AgoraRTM.LOG_FILTER_OFF });\n\n        this.rtmClient.on('ConnectionStateChanged', (newState, reason) => {\n          console.log('this.rtmClient connection state changed to ' + newState + ' reason: ' + reason);\n          if (newState == \"CONNECTED\") {\n          } else {\n          }\n        });\n\n        this.rtmClient.on('MessageFromPeer', ({ text }, senderId) => {\n          this.handleRTM(senderId, text);\n        });\n\n\n        this.rtmClient.login({ token: null, uid: this.rtmUid }).then(() => {\n          this.rtmChannel = this.rtmClient.createChannel(this.room);\n          this.rtmChannel.on('MemberJoined', (memberId) => {\n          });\n          this.rtmChannel.on('MemberLeft', (memberId) => {\n          });\n          this.rtmChannel.join().then(() => {\n            this.rtmChannel.on('ChannelMessage', ({ text }, senderId) => {\n              this.handleRTM(senderId, text);\n            });\n            success(this.clientId);//[this.clientId,this.clientId]);\n          }).catch(error => {\n            console.log('AgoraRTM client join failure', error);\n          });\n        }).catch(error => {\n          console.log('AgoraRTM client login failure', error);\n        });\n      }\n   }\n  }\n\n  /**\n   * Privates\n   */\n\n  async _connect(connectSuccess, connectFailure) {\n    var that = this;\n   // let x = function () { /* empty because ... */ };\n   if (!this.easyrtc){\n    return;\n  }\n    await that.easyrtc.connect(that.app, connectSuccess, connectFailure);\n  }\n\n  _getRoomJoinTime(clientId) {\n    var myRoomId = this.room; //NAF.room;\n    if (!this.easyrtc){\n      return;\n    }\n    var joinTime = this.easyrtc.getRoomOccupantsAsMap(myRoomId)[clientId].roomJoinTime;\n    return joinTime;\n  }\n\n  getServerTime() {\n    return Date.now() + this.avgTimeOffset;\n  }\n}\n\nNAF.adapters.register(\"agorartc\", AgoraRtcAdapter);\nmodule.exports = AgoraRtcAdapter;\n"],"sourceRoot":""}