{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","AgoraRtcAdapter","constructor","easyrtc","console","log","this","window","app","room","userid","appid","mediaStreams","remoteClients","pendingMediaRequests","Map","enableVideo","enableVideoFiltered","enableAudio","enableAvatar","localTracks","videoTrack","audioTrack","error","token","clientId","uid","vbg","vbg0","showLocal","virtualBackgroundInstance","extension","processor","pipeProcessor","track","pipe","processorDestination","serverTimeRequests","timeOffsets","avgTimeOffset","agoraClient","setPeerOpenListener","clientConnection","getPeerConnectionByUserId","setPeerClosedListener","setServerUrl","url","setSocketUrl","setApp","appName","json","replace","obj","JSON","parse","AgoraRTC","loadModule","SegPlugin","joinRoom","setWebRtcOptions","options","enableDataChannels","datachannel","video","audio","enableVideoReceive","enableAudioReceive","setServerConnectListeners","successListener","failureListener","connectSuccess","connectFailure","setRoomOccupantListener","occupantListener","roomName","occupants","primary","setDataChannelListeners","openListener","closedListener","messageListener","setDataChannelOpenListener","setDataChannelCloseListener","setPeerListener","updateTimeOffset","clientSentTime","Date","now","fetch","document","location","href","method","cache","then","res","serverReceivedTime","headers","getTime","precision","clientReceivedTime","timeOffset","push","reduce","acc","offset","length","setTimeout","connect","Promise","all","resolve","reject","_connect","_","_myRoomJoinTime","_getRoomJoinTime","connectAgora","catch","shouldStartConnectionTo","client","roomJoinTime","startStreamConnection","caller","media","NAF","write","errorCode","errorText","wasAccepted","closeStreamConnection","hangup","sendData","dataType","data","sendDataGuaranteed","sendDataWS","broadcastData","roomOccupants","getRoomOccupantsAsMap","roomOccupant","myEasyrtcid","broadcastDataGuaranteed","destination","targetRoom","getConnectStatus","status","IS_CONNECTED","adapters","NOT_CONNECTED","CONNECTING","getMediaStream","streamName","has","audioPromise","e","warn","promise","videoPromise","set","streamPromise","setMediaStream","stream","clientMediaStreams","audioTracks","getAudioTracks","audioStream","MediaStream","forEach","addTrack","videoTracks","getVideoTracks","videoStream","addLocalMediaStream","id","register3rdPartyLocalMediaStream","keys","addStreamToCall","removeLocalMediaStream","closeLocalMediaStream","enableMicrophone","enabled","enableCamera","disconnect","user","mediaType","handleUserUnpublished","that","createClient","codec","setClientRole","on","async","subscribe","play","_mediaStreamTrack","querySelector","srcObject","getElementById","captureStream","join","createMicrophoneAudioTrack","createCustomVideoTrack","mediaStreamTrack","createCameraVideoTrack","encoderConfig","cams","getCameras","label","indexOf","deviceId","setDevice","imgElement","createElement","onload","inject","setOptions","enable","background","src","VirtualBackgroundExtension","registerExtensions","createProcessor","init","type","color","publish","values","myRoomId","getServerTime","register"],"mappings":"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","file":"naf-agora-adapter.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","class AgoraRtcAdapter {\n\n  constructor(easyrtc) {\n    console.log(\"BW73 constructor \", easyrtc);\n\n    this.easyrtc = easyrtc || window.easyrtc;\n    this.app = \"default\";\n    this.room = \"default\";\n    this.userid = 0;\n    this.appid = null;\n\n    this.mediaStreams = {};\n    this.remoteClients = {};\n    this.pendingMediaRequests = new Map();\n\n    this.enableVideo = false;\n    this.enableVideoFiltered = false;\n    this.enableAudio = false;\n    this.enableAvatar = false;\n\n    this.localTracks = { videoTrack: null, audioTrack: null };\n    window.localTracks = this.localTracks;\n    console.error(\"ASS \", window.localTracks);\n    this.token = null;\n    this.clientId = null;\n    this.uid = null;\n    this.vbg = false;\n    this.vbg0 = false;\n    this.showLocal = false;\n    this.virtualBackgroundInstance = null;\n    this.extension = null;\n    this.processor = null;\n    this.pipeProcessor = (track, processor) => {\n      track.pipe(processor).pipe(track.processorDestination);\n    }\n\n\n    this.serverTimeRequests = 0;\n    this.timeOffsets = [];\n    this.avgTimeOffset = 0;\n    this.agoraClient = null;\n\n    this.easyrtc.setPeerOpenListener(clientId => {\n      const clientConnection = this.easyrtc.getPeerConnectionByUserId(clientId);\n      this.remoteClients[clientId] = clientConnection;\n    });\n\n    this.easyrtc.setPeerClosedListener(clientId => {\n      delete this.remoteClients[clientId];\n    });\n  }\n\n  setServerUrl(url) {\n    console.log(\"BW73 setServerUrl \", url);\n    this.easyrtc.setSocketUrl(url);\n  }\n\n  setApp(appName) {\n    console.log(\"BW73 setApp \", appName);\n    this.app = appName;\n    this.appid = appName;\n  }\n\n  async setRoom(json) {\n    json = json.replace(/'/g, '\"');\n    const obj = JSON.parse(json);\n    this.room = obj.name;\n\n    if (obj.vbg) {\n      this.vbg = obj.vbg;\n    }\n\n    if (obj.vbg0) {\n      this.vbg0 = obj.vbg0;\n      if (this.vbg0) {\n        AgoraRTC.loadModule(SegPlugin, {});\n      }\n    }\n\n\n    if (obj.enableAvatar) {\n      this.enableAvatar = obj.enableAvatar;\n    }\n\n    if (obj.showLocal) {\n      this.showLocal = obj.showLocal;\n    }\n\n    if (obj.enableVideoFiltered) {\n      this.enableVideoFiltered = obj.enableVideoFiltered;\n    }\n    this.easyrtc.joinRoom(this.room, null);\n  }\n\n  // options: { datachannel: bool, audio: bool, video: bool }\n  setWebRtcOptions(options) {\n    console.log(\"BW73 setWebRtcOptions \", options);\n    // this.easyrtc.enableDebug(true);\n    this.easyrtc.enableDataChannels(options.datachannel);\n\n    // using Agora\n    this.enableVideo = options.video;\n    this.enableAudio = options.audio;\n\n    // not easyrtc\n    this.easyrtc.enableVideo(false);\n    this.easyrtc.enableAudio(false);\n    this.easyrtc.enableVideoReceive(false);\n    this.easyrtc.enableAudioReceive(false);\n  }\n\n  setServerConnectListeners(successListener, failureListener) {\n    console.log(\"BW73 setServerConnectListeners \", successListener, failureListener);\n    this.connectSuccess = successListener;\n    this.connectFailure = failureListener;\n  }\n\n  setRoomOccupantListener(occupantListener) {\n    console.log(\"BW73 setRoomOccupantListener \", occupantListener);\n\n    this.easyrtc.setRoomOccupantListener(function (roomName, occupants, primary) {\n      occupantListener(occupants);\n    });\n  }\n\n  setDataChannelListeners(openListener, closedListener, messageListener) {\n    console.log(\"BW73 setDataChannelListeners  \", openListener, closedListener, messageListener);\n    this.easyrtc.setDataChannelOpenListener(openListener);\n    this.easyrtc.setDataChannelCloseListener(closedListener);\n    this.easyrtc.setPeerListener(messageListener);\n  }\n\n  updateTimeOffset() {\n    console.log(\"BW73 updateTimeOffset \");\n    const clientSentTime = Date.now() + this.avgTimeOffset;\n\n    return fetch(document.location.href, { method: \"HEAD\", cache: \"no-cache\" }).then(res => {\n      var precision = 1000;\n      var serverReceivedTime = new Date(res.headers.get(\"Date\")).getTime() + precision / 2;\n      var clientReceivedTime = Date.now();\n      var serverTime = serverReceivedTime + (clientReceivedTime - clientSentTime) / 2;\n      var timeOffset = serverTime - clientReceivedTime;\n\n      this.serverTimeRequests++;\n\n      if (this.serverTimeRequests <= 10) {\n        this.timeOffsets.push(timeOffset);\n      } else {\n        this.timeOffsets[this.serverTimeRequests % 10] = timeOffset;\n      }\n\n      this.avgTimeOffset = this.timeOffsets.reduce((acc, offset) => acc += offset, 0) / this.timeOffsets.length;\n\n      if (this.serverTimeRequests > 10) {\n        setTimeout(() => this.updateTimeOffset(), 5 * 60 * 1000); // Sync clock every 5 minutes.\n      } else {\n        this.updateTimeOffset();\n      }\n    });\n  }\n\n  connect() {\n    console.log(\"BW73 connect \");\n    Promise.all([this.updateTimeOffset(), new Promise((resolve, reject) => {\n      this._connect(resolve, reject);\n    })]).then(([_, clientId]) => {\n      console.log(\"BW73 connected \" + clientId);\n      this.clientId = clientId;\n      this._myRoomJoinTime = this._getRoomJoinTime(clientId);\n      this.connectAgora();\n      this.connectSuccess(clientId);\n    }).catch(this.connectFailure);\n  }\n\n  shouldStartConnectionTo(client) {\n    return this._myRoomJoinTime <= client.roomJoinTime;\n  }\n\n  startStreamConnection(clientId) {\n    console.log(\"BW73 startStreamConnection \", clientId);\n    this.easyrtc.call(clientId, function (caller, media) {\n      if (media === \"datachannel\") {\n        NAF.log.write(\"Successfully started datachannel to \", caller);\n      }\n    }, function (errorCode, errorText) {\n      NAF.log.error(errorCode, errorText);\n    }, function (wasAccepted) {\n      // console.log(\"was accepted=\" + wasAccepted);\n    });\n  }\n\n  closeStreamConnection(clientId) {\n    console.log(\"BW73 closeStreamConnection \", clientId);\n    this.easyrtc.hangup(clientId);\n  }\n\n  sendData(clientId, dataType, data) {\n    console.log(\"BW73 sendData \", clientId, dataType, data);\n    // send via webrtc otherwise fallback to websockets\n    this.easyrtc.sendData(clientId, dataType, data);\n  }\n\n  sendDataGuaranteed(clientId, dataType, data) {\n    console.log(\"BW73 sendDataGuaranteed \", clientId, dataType, data);\n    this.easyrtc.sendDataWS(clientId, dataType, data);\n  }\n\n  broadcastData(dataType, data) {\n    console.log(\"BW73 broadcastData \", dataType, data);\n    var roomOccupants = this.easyrtc.getRoomOccupantsAsMap(this.room);\n\n    // Iterate over the keys of the easyrtc room occupants map.\n    // getRoomOccupantsAsArray uses Object.keys which allocates memory.\n    for (var roomOccupant in roomOccupants) {\n      if (roomOccupants[roomOccupant] && roomOccupant !== this.easyrtc.myEasyrtcid) {\n        // send via webrtc otherwise fallback to websockets\n        this.easyrtc.sendData(roomOccupant, dataType, data);\n      }\n    }\n  }\n\n  broadcastDataGuaranteed(dataType, data) {\n    console.log(\"BW73 broadcastDataGuaranteed \", dataType, data);\n    var destination = { targetRoom: this.room };\n    this.easyrtc.sendDataWS(destination, dataType, data);\n  }\n\n  getConnectStatus(clientId) {\n    console.log(\"BW73 getConnectStatus \", clientId);\n    var status = this.easyrtc.getConnectStatus(clientId);\n\n    if (status == this.easyrtc.IS_CONNECTED) {\n      return NAF.adapters.IS_CONNECTED;\n    } else if (status == this.easyrtc.NOT_CONNECTED) {\n      return NAF.adapters.NOT_CONNECTED;\n    } else {\n      return NAF.adapters.CONNECTING;\n    }\n  }\n\n  getMediaStream(clientId, streamName = \"audio\") {\n\n    console.log(\"BW73 getMediaStream \", clientId, streamName);\n    // if ( streamName = \"audio\") {\n    //streamName = \"bod_audio\";\n    //}\n\n    if (this.mediaStreams[clientId] && this.mediaStreams[clientId][streamName]) {\n      NAF.log.write(`Already had ${streamName} for ${clientId}`);\n      return Promise.resolve(this.mediaStreams[clientId][streamName]);\n    } else {\n      NAF.log.write(`Waiting on ${streamName} for ${clientId}`);\n\n      // Create initial pendingMediaRequests with audio|video alias\n      if (!this.pendingMediaRequests.has(clientId)) {\n        const pendingMediaRequests = {};\n\n        const audioPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.audio = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Audio Error`, e));\n\n        pendingMediaRequests.audio.promise = audioPromise;\n\n        const videoPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.video = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Video Error`, e));\n        pendingMediaRequests.video.promise = videoPromise;\n\n        this.pendingMediaRequests.set(clientId, pendingMediaRequests);\n      }\n\n      const pendingMediaRequests = this.pendingMediaRequests.get(clientId);\n\n      // Create initial pendingMediaRequests with streamName\n      if (!pendingMediaRequests[streamName]) {\n        const streamPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests[streamName] = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream \"${streamName}\" Error`, e));\n        pendingMediaRequests[streamName].promise = streamPromise;\n      }\n\n      return this.pendingMediaRequests.get(clientId)[streamName].promise;\n    }\n  }\n\n  setMediaStream(clientId, stream, streamName) {\n    console.log(\"BW73 setMediaStream \", clientId, stream, streamName);\n    const pendingMediaRequests = this.pendingMediaRequests.get(clientId); // return undefined if there is no entry in the Map\n    const clientMediaStreams = this.mediaStreams[clientId] = this.mediaStreams[clientId] || {};\n\n    if (streamName === 'default') {\n      // Safari doesn't like it when you use a mixed media stream where one of the tracks is inactive, so we\n      // split the tracks into two streams.\n      // Add mediaStreams audio streamName alias\n      const audioTracks = stream.getAudioTracks();\n      if (audioTracks.length > 0) {\n        const audioStream = new MediaStream();\n        try {\n          audioTracks.forEach(track => audioStream.addTrack(track));\n          clientMediaStreams.audio = audioStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"audio\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream audio alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      // Add mediaStreams video streamName alias\n      const videoTracks = stream.getVideoTracks();\n      if (videoTracks.length > 0) {\n        const videoStream = new MediaStream();\n        try {\n          videoTracks.forEach(track => videoStream.addTrack(track));\n          clientMediaStreams.video = videoStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"video\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream video alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n      }\n    } else {\n      clientMediaStreams[streamName] = stream;\n\n      // Resolve the promise for the user's media stream by StreamName if it exists.\n      if (pendingMediaRequests && pendingMediaRequests[streamName]) {\n        pendingMediaRequests[streamName].resolve(stream);\n      }\n    }\n  }\n\n  addLocalMediaStream(stream, streamName) {\n    console.log(\"BW73 addLocalMediaStream \", stream, streamName);\n    const easyrtc = this.easyrtc;\n    streamName = streamName || stream.id;\n    this.setMediaStream(\"local\", stream, streamName);\n    easyrtc.register3rdPartyLocalMediaStream(stream, streamName);\n\n    // Add local stream to existing connections\n    Object.keys(this.remoteClients).forEach(clientId => {\n      if (easyrtc.getConnectStatus(clientId) !== easyrtc.NOT_CONNECTED) {\n        easyrtc.addStreamToCall(clientId, streamName);\n      }\n    });\n  }\n\n  removeLocalMediaStream(streamName) {\n    console.log(\"BW73 removeLocalMediaStream \", streamName);\n    this.easyrtc.closeLocalMediaStream(streamName);\n    delete this.mediaStreams[\"local\"][streamName];\n  }\n\n  enableMicrophone(enabled) {\n    console.log(\"BW73 enableMicrophone \", enabled);\n    this.easyrtc.enableMicrophone(enabled);\n  }\n\n  enableCamera(enabled) {\n    console.log(\"BW73 enableCamera \", enabled);\n    this.easyrtc.enableCamera(enabled);\n  }\n\n  disconnect() {\n    console.log(\"BW73 disconnect \");\n    this.easyrtc.disconnect();\n  }\n\n  async handleUserPublished(user, mediaType) { }\n\n  handleUserUnpublished(user, mediaType) {\n    console.log(\"BW73 handleUserUnPublished \");\n  }\n\n  async connectAgora() {\n    // Add an event listener to play remote tracks when remote user publishes.\n    var that = this;\n\n    this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    if (this.enableVideoFiltered || this.enableVideo || this.enableAudio) {\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"rtc\", codec: \"vp8\" });\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"h264\" });\n      this.agoraClient.setClientRole(\"host\");\n    } else {\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"h264\" });\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    }\n\n    this.agoraClient.on(\"user-joined\", async (user) => {\n      console.warn(\"user-joined\", user);\n    });\n    this.agoraClient.on(\"user-published\", async (user, mediaType) => {\n\n      let clientId = user.uid;\n      console.log(\"BW73 handleUserPublished \" + clientId + \" \" + mediaType, that.agoraClient);\n      await that.agoraClient.subscribe(user, mediaType);\n      console.log(\"BW73 handleUserPublished2 \" + clientId + \" \" + that.agoraClient);\n\n      const pendingMediaRequests = that.pendingMediaRequests.get(clientId);\n      const clientMediaStreams = that.mediaStreams[clientId] = that.mediaStreams[clientId] || {};\n\n      if (mediaType === 'audio') {\n        user.audioTrack.play();\n\n        const audioStream = new MediaStream();\n        console.log(\"user.audioTrack \", user.audioTrack._mediaStreamTrack);\n        //audioStream.addTrack(user.audioTrack._mediaStreamTrack);\n        clientMediaStreams.audio = audioStream;\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      let videoStream = null;\n      if (mediaType === 'video') {\n        videoStream = new MediaStream();\n        console.log(\"user.videoTrack \", user.videoTrack._mediaStreamTrack);\n        videoStream.addTrack(user.videoTrack._mediaStreamTrack);\n        clientMediaStreams.video = videoStream;\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n        //user.videoTrack\n      }\n\n      if (clientId == 'CCC') {\n        if (mediaType === 'video') {\n          // document.getElementById(\"video360\").srcObject=videoStream;\n          //document.querySelector(\"#video360\").setAttribute(\"src\", videoStream);\n          //document.querySelector(\"#video360\").setAttribute(\"src\", user.videoTrack._mediaStreamTrack);\n          //document.querySelector(\"#video360\").srcObject= user.videoTrack._mediaStreamTrack;\n          document.querySelector(\"#video360\").srcObject = videoStream;\n          document.querySelector(\"#video360\").play();\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n      if (clientId == 'DDD') {\n        if (mediaType === 'video') {\n          user.videoTrack.play(\"video360\");\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n    });\n\n    this.agoraClient.on(\"user-unpublished\", that.handleUserUnpublished);\n\n    console.log(\"connect agora \");\n    // Join a channel and create local tracks. Best practice is to use Promise.all and run them concurrently.\n    // o\n\n\n    if (this.enableAvatar) {\n      var stream = document.getElementById(\"canvas\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideoFiltered && this.enableAudio) {\n      var stream = document.getElementById(\"canvas_secret\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideo && this.enableAudio) {\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCameraVideoTrack({ encoderConfig: '480p_2' })]);\n    } else if (this.enableVideo) {\n      [this.userid, this.localTracks.videoTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createCameraVideoTrack(\"360p_4\")]);\n    } else if (this.enableAudio) {\n      [this.userid, this.localTracks.audioTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createMicrophoneAudioTrack()]);\n    } else {\n      this.userid = await this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null);\n    }\n\n\n    // select facetime camera if exists\n    if (this.enableVideo && !this.enableVideoFiltered) {\n      let cams = await AgoraRTC.getCameras();\n      for (var i = 0; i < cams.length; i++) {\n        if (cams[i].label.indexOf(\"FaceTime\") == 0) {\n          console.log(\"select FaceTime camera\", cams[i].deviceId);\n          await this.localTracks.videoTrack.setDevice(cams[i].deviceId);\n        }\n      }\n    }\n\n    if (this.enableVideo && this.showLocal) {\n      this.localTracks.videoTrack.play(\"local-player\");\n    }\n\n    // Enable virtual background OLD Method\n    if (this.enableVideo && this.vbg0 && this.localTracks.videoTrack) {\n      const imgElement = document.createElement('img');\n      imgElement.onload = async () => {\n        if (!this.virtualBackgroundInstance) {\n          console.log(\"SEG INIT \", this.localTracks.videoTrack);\n          this.virtualBackgroundInstance = await SegPlugin.inject(this.localTracks.videoTrack, \"/assets/wasms0\").catch(console.error);\n          console.log(\"SEG INITED\");\n        }\n        this.virtualBackgroundInstance.setOptions({ enable: true, background: imgElement });\n      };\n      imgElement.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAAD0lEQVR4XmNg+M+AQDg5AOk9C/VkomzYAAAAAElFTkSuQmCC';\n    }\n\n    // Enable virtual background New Method\n    if (this.enableVideo && this.vbg && this.localTracks.videoTrack) {\n\n      this.extension = new VirtualBackgroundExtension();\n      AgoraRTC.registerExtensions([this.extension]);\n      this.processor = this.extension.createProcessor();\n      await this.processor.init(\"/assets/wasms\");\n      this.localTracks.videoTrack.pipe(this.processor).pipe(this.localTracks.videoTrack.processorDestination);\n      await this.processor.setOptions({ type: 'color', color: \"#00ff00\" });\n      await this.processor.enable();\n    }\n\n    window.localTracks = this.localTracks;\n\n    console.error(\"ASS 2 \", window.localTracks);\n\n    // Publish the local video and audio tracks to the channel.\n    if (this.enableVideo || this.enableAudio || this.enableAvatar) {\n      await this.agoraClient.publish(Object.values(this.localTracks));\n      console.log(\"publish success\");\n    }\n\n  }\n\n  /**\n   * Privates\n   */\n\n  async _connect(connectSuccess, connectFailure) {\n    var that = this;\n\n    await that.easyrtc.connect(that.app, connectSuccess, connectFailure);\n\n    /*\n       this.easyrtc.setStreamAcceptor(this.setMediaStream.bind(this));\n       this.easyrtc.setOnStreamClosed(function(clientId, stream, streamName) {\n        delete this.mediaStreams[clientId][streamName];\n      });\n       if (that.easyrtc.audioEnabled || that.easyrtc.videoEnabled) {\n        navigator.mediaDevices.getUserMedia({\n          video: that.easyrtc.videoEnabled,\n          audio: that.easyrtc.audioEnabled\n        }).then(\n          function(stream) {\n            that.addLocalMediaStream(stream, \"default\");\n            that.easyrtc.connect(that.app, connectSuccess, connectFailure);\n          },\n          function(errorCode, errmesg) {\n            NAF.log.error(errorCode, errmesg);\n          }\n        );\n      } else {\n        that.easyrtc.connect(that.app, connectSuccess, connectFailure);\n      }\n      */\n  }\n\n  _getRoomJoinTime(clientId) {\n    var myRoomId = this.room; //NAF.room;\n    var joinTime = this.easyrtc.getRoomOccupantsAsMap(myRoomId)[clientId].roomJoinTime;\n    return joinTime;\n  }\n\n  getServerTime() {\n    return Date.now() + this.avgTimeOffset;\n  }\n}\n\nNAF.adapters.register(\"agorartc\", AgoraRtcAdapter);\n\nmodule.exports = AgoraRtcAdapter;\n"],"sourceRoot":""}