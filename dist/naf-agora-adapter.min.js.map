{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","AgoraRtcAdapter","constructor","easyrtc","console","log","this","window","app","room","userid","appid","mocapData","mocapPrevData","logi","logo","mediaStreams","remoteClients","pendingMediaRequests","Map","enableVideo","enableVideoFiltered","enableAudio","enableAvatar","localTracks","videoTrack","audioTrack","token","clientId","uid","vbg","vbg0","showLocal","virtualBackgroundInstance","extension","processor","pipeProcessor","track","pipe","processorDestination","serverTimeRequests","timeOffsets","avgTimeOffset","agoraClient","setPeerOpenListener","clientConnection","getPeerConnectionByUserId","setPeerClosedListener","isChrome","navigator","userAgent","indexOf","oldRTCPeerConnection","RTCPeerConnection","Proxy","construct","target","args","length","push","encodedInsertableStreams","oldSetConfiguration","setConfiguration","arguments","apply","CustomDataDetector","CustomDatLengthByteCount","senderChannel","MessageChannel","receiverChannel","r_receiver","r_clientId","_vad_audioTrack","_voiceActivityDetectionFrequency","_vad_MaxAudioSamples","_vad_MaxBackgroundNoiseLevel","_vad_SilenceOffeset","_vad_audioSamplesArr","_vad_audioSamplesArrSorted","_vad_exceedCount","_vad_exceedCountThreshold","_vad_exceedCountThresholdLow","_voiceActivityDetectionInterval","setServerUrl","url","setSocketUrl","setApp","appName","json","replace","obj","JSON","parse","AgoraRTC","loadModule","SegPlugin","joinRoom","setWebRtcOptions","options","enableDataChannels","datachannel","video","audio","enableVideoReceive","enableAudioReceive","setServerConnectListeners","successListener","failureListener","connectSuccess","connectFailure","setRoomOccupantListener","occupantListener","roomName","occupants","primary","setDataChannelListeners","openListener","closedListener","messageListener","setDataChannelOpenListener","setDataChannelCloseListener","setPeerListener","updateTimeOffset","clientSentTime","Date","now","fetch","document","location","href","method","cache","then","res","serverReceivedTime","headers","getTime","precision","clientReceivedTime","timeOffset","reduce","acc","offset","setTimeout","connect","Promise","all","resolve","reject","_connect","_","_myRoomJoinTime","_getRoomJoinTime","connectAgora","catch","shouldStartConnectionTo","client","roomJoinTime","startStreamConnection","caller","media","NAF","write","errorCode","errorText","error","wasAccepted","closeStreamConnection","hangup","sendMocap","mocap","port1","postMessage","watermark","sender","streams","createEncodedStreams","textEncoder","TextEncoder","that","transformer","TransformStream","transform","chunk","controller","encode","frame","data","Uint8Array","byteLength","set","bytes","getIntBytes","magicIndex","charCodeAt","buffer","enqueue","readable","pipeThrough","pipeTo","writable","worker","Worker","onmessage","event","senderTransform","RTCRtpScriptTransform","port","port2","e","createDecoder","receiver","textDecoder","TextDecoder","view","DataView","magicData","magic","String","fromCharCode","mocapLen","getUint32","frameSize","mocapBuffer","decode","remoteMocap","ArrayBuffer","receiverTransform","sendData","dataType","sendDataGuaranteed","sendDataWS","broadcastData","broadcastDataGuaranteed","destination","targetRoom","getConnectStatus","status","IS_CONNECTED","adapters","NOT_CONNECTED","CONNECTING","getMediaStream","streamName","has","audioPromise","warn","promise","videoPromise","streamPromise","setMediaStream","stream","clientMediaStreams","audioTracks","getAudioTracks","audioStream","MediaStream","forEach","addTrack","videoTracks","getVideoTracks","videoStream","x","addLocalMediaStream","id","register3rdPartyLocalMediaStream","keys","addStreamToCall","removeLocalMediaStream","closeLocalMediaStream","enableMicrophone","enabled","enableCamera","disconnect","user","mediaType","handleUserUnpublished","getInputLevel","analyser","_source","volumeLevelAnalyser","analyserNode","bufferLength","frequencyBinCount","getByteFrequencyData","values","Math","floor","voiceActivityDetection","_enabled","audioLevel","removed","shift","removedIndex","splice","sort","a","b","_state_stop_at","createClient","codec","setClientRole","on","async","subscribe","play","_mediaStreamTrack","querySelector","srcObject","enc_id","receivers","_p2pChannel","connection","peerConnection","getReceivers","getElementById","captureStream","join","createMicrophoneAudioTrack","createCustomVideoTrack","mediaStreamTrack","createCameraVideoTrack","encoderConfig","audio_track","gum_stream","createCustomAudioTrack","setInterval","cams","getCameras","label","deviceId","setDevice","imgElement","createElement","onload","inject","setOptions","enable","background","src","VirtualBackgroundExtension","registerExtensions","createProcessor","init","type","color","publish","senders","getSenders","kind","createEncoder","myRoomId","getRoomOccupantsAsMap","getServerTime","register"],"mappings":"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","file":"naf-agora-adapter.min.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","class AgoraRtcAdapter {\n\n  constructor(easyrtc) {\n    \n    console.log(\"BW73 constructor \", easyrtc);\n\n    this.easyrtc = easyrtc || window.easyrtc;\n    this.app = \"default\";\n    this.room = \"default\";\n    this.userid = 0;\n    this.appid = null;\n    this.mocapData=\"\";\n    this.mocapPrevData=\"\";\n    this.logi=0;\n    this.logo=0;\n    this.mediaStreams = {};\n    this.remoteClients = {};\n    this.pendingMediaRequests = new Map();\n\n    this.enableVideo = false;\n    this.enableVideoFiltered = false;\n    this.enableAudio = false;\n    this.enableAvatar = false;\n\n    this.localTracks = { videoTrack: null, audioTrack: null };\n    window.localTracks = this.localTracks;\n    this.token = null;\n    this.clientId = null;\n    this.uid = null;\n    this.vbg = false;\n    this.vbg0 = false;\n    this.showLocal = false;\n    this.virtualBackgroundInstance = null;\n    this.extension = null;\n    this.processor = null;\n    this.pipeProcessor = (track, processor) => {\n      track.pipe(processor).pipe(track.processorDestination);\n    }\n\n    this.serverTimeRequests = 0;\n    this.timeOffsets = [];\n    this.avgTimeOffset = 0;\n    this.agoraClient = null;\n\n    this.easyrtc.setPeerOpenListener(clientId => {\n      const clientConnection = this.easyrtc.getPeerConnectionByUserId(clientId);\n      this.remoteClients[clientId] = clientConnection;\n    });\n\n    this.easyrtc.setPeerClosedListener(clientId => {\n      delete this.remoteClients[clientId];\n    });\n\n    this.isChrome = (navigator.userAgent.indexOf('Firefox') === -1 && navigator.userAgent.indexOf('Chrome') > -1);\n\n    if (this.isChrome) {\n      window.oldRTCPeerConnection = RTCPeerConnection;\n      window.RTCPeerConnection = new Proxy(window.RTCPeerConnection, {\n        construct: function (target, args) {\n          if (args.length > 0) {\n            args[0][\"encodedInsertableStreams\"] = true;\n          } else {\n            args.push({ encodedInsertableStreams: true });\n          }\n      \n          const pc = new window.oldRTCPeerConnection(...args);\n          return pc;\n        },\n      });\n      const oldSetConfiguration = window.RTCPeerConnection.prototype.setConfiguration;\n      window.RTCPeerConnection.prototype.setConfiguration = function () {\n        const args = arguments;\n        if (args.length > 0) {\n          args[0][\"encodedInsertableStreams\"] = true;\n        } else {\n          args.push({ encodedInsertableStreams: true });\n        }\n      \n        oldSetConfiguration.apply(this, args);\n      };\n    }\n    \n    // custom data append params\n    this.CustomDataDetector = 'AGORAMOCAP';\n    this.CustomDatLengthByteCount = 4;\n    this.senderChannel = new MessageChannel;\n    this.receiverChannel;\n    this.r_receiver=null;\n    this.r_clientId=null;\n\n    this._vad_audioTrack = null;\n    this._voiceActivityDetectionFrequency = 150;\n  \n    this._vad_MaxAudioSamples = 400;\n    this._vad_MaxBackgroundNoiseLevel = 30;\n    this._vad_SilenceOffeset = 10;\n    this._vad_audioSamplesArr = [];\n    this._vad_audioSamplesArrSorted = [];\n    this._vad_exceedCount = 0;\n    this._vad_exceedCountThreshold = 2;\n    this._vad_exceedCountThresholdLow = 1;\n    this._voiceActivityDetectionInterval;\n\n\n    \n    window.AgoraRtcAdapter=this;\n    \n  }\n\n  setServerUrl(url) {\n    console.log(\"BW73 setServerUrl \", url);\n    this.easyrtc.setSocketUrl(url);\n  }\n\n  setApp(appName) {\n    console.log(\"BW73 setApp \", appName);\n    this.app = appName;\n    this.appid = appName;\n  }\n\n  async setRoom(json) {\n    json = json.replace(/'/g, '\"');\n    const obj = JSON.parse(json);\n    this.room = obj.name;\n\n    if (obj.vbg && obj.vbg=='true' ) {      \n      this.vbg = true;\n    }\n\n    if (obj.vbg0 && obj.vbg0=='true' ) {\n      this.vbg0 = true;\n      AgoraRTC.loadModule(SegPlugin, {});\n    }\n\n    if (obj.enableAvatar && obj.enableAvatar=='true' ) {\n      this.enableAvatar = true;\n    }\n\n    if (obj.showLocal  && obj.showLocal=='true') {\n      this.showLocal = true;\n    }\n\n    if (obj.enableVideoFiltered && obj.enableVideoFiltered=='true' ) {\n      this.enableVideoFiltered = true;\n    }\n    this.easyrtc.joinRoom(this.room, null);\n  }\n\n  // options: { datachannel: bool, audio: bool, video: bool }\n  setWebRtcOptions(options) {\n    console.log(\"BW73 setWebRtcOptions \", options);\n    // this.easyrtc.enableDebug(true);\n    this.easyrtc.enableDataChannels(options.datachannel);\n\n    // using Agora\n    this.enableVideo = options.video;\n    this.enableAudio = options.audio;\n\n    // not easyrtc\n    this.easyrtc.enableVideo(false);\n    this.easyrtc.enableAudio(false);\n    this.easyrtc.enableVideoReceive(false);\n    this.easyrtc.enableAudioReceive(false);\n  }\n\n  setServerConnectListeners(successListener, failureListener) {\n    console.log(\"BW73 setServerConnectListeners \", successListener, failureListener);\n    this.connectSuccess = successListener;\n    this.connectFailure = failureListener;\n  }\n\n  setRoomOccupantListener(occupantListener) {\n    console.log(\"BW73 setRoomOccupantListener \", occupantListener);\n\n    this.easyrtc.setRoomOccupantListener(function (roomName, occupants, primary) {\n      occupantListener(occupants);\n    });\n  }\n\n  setDataChannelListeners(openListener, closedListener, messageListener) {\n    console.log(\"BW73 setDataChannelListeners  \", openListener, closedListener, messageListener);\n    this.easyrtc.setDataChannelOpenListener(openListener);\n    this.easyrtc.setDataChannelCloseListener(closedListener);\n    this.easyrtc.setPeerListener(messageListener);\n  }\n\n  updateTimeOffset() {\n    console.log(\"BW73 updateTimeOffset \");\n    const clientSentTime = Date.now() + this.avgTimeOffset;\n\n    return fetch(document.location.href, { method: \"HEAD\", cache: \"no-cache\" }).then(res => {\n      var precision = 1000;\n      var serverReceivedTime = new Date(res.headers.get(\"Date\")).getTime() + precision / 2;\n      var clientReceivedTime = Date.now();\n      var serverTime = serverReceivedTime + (clientReceivedTime - clientSentTime) / 2;\n      var timeOffset = serverTime - clientReceivedTime;\n\n      this.serverTimeRequests++;\n\n      if (this.serverTimeRequests <= 10) {\n        this.timeOffsets.push(timeOffset);\n      } else {\n        this.timeOffsets[this.serverTimeRequests % 10] = timeOffset;\n      }\n\n      this.avgTimeOffset = this.timeOffsets.reduce((acc, offset) => acc += offset, 0) / this.timeOffsets.length;\n\n      if (this.serverTimeRequests > 10) {\n        setTimeout(() => this.updateTimeOffset(), 5 * 60 * 1000); // Sync clock every 5 minutes.\n      } else {\n        this.updateTimeOffset();\n      }\n    });\n  }\n\n  connect() {\n    console.log(\"BW73 connect \");\n    Promise.all([this.updateTimeOffset(), new Promise((resolve, reject) => {\n      this._connect(resolve, reject);\n    })]).then(([_, clientId]) => {\n      console.log(\"BW73 connected \" + clientId);\n      this.clientId = clientId;\n      this._myRoomJoinTime = this._getRoomJoinTime(clientId);\n      this.connectAgora();\n      this.connectSuccess(clientId);\n    }).catch(this.connectFailure);\n  }\n\n  shouldStartConnectionTo(client) {\n    return this._myRoomJoinTime <= client.roomJoinTime;\n  }\n\n  startStreamConnection(clientId) {\n    console.log(\"BW73 startStreamConnection \", clientId);\n    this.easyrtc.call(clientId, function (caller, media) {\n      if (media === \"datachannel\") {\n        NAF.log.write(\"Successfully started datachannel to \", caller);\n      }\n    }, function (errorCode, errorText) {\n      NAF.log.error(errorCode, errorText);\n    }, function (wasAccepted) {\n      // console.log(\"was accepted=\" + wasAccepted);\n    });\n  }\n\n  closeStreamConnection(clientId) {\n    console.log(\"BW73 closeStreamConnection \", clientId);\n    this.easyrtc.hangup(clientId);\n  }\n\n  sendMocap(mocap) {\n    if (mocap==this.mocapPrevData){\n   //   console.log(\"blank\");\n      mocap=\"\";\n    }\n\n    // set to blank after sending\n    if (this.mocapData===\"\") {\n      this.mocapData=mocap;\n    }\n\n    if (!this.isChrome) {\n      this.senderChannel.port1.postMessage({ watermark: mocap });\n    }\n  }\n\n  async createEncoder(sender) {\n    if (this.isChrome) {\n      const streams = sender.createEncodedStreams();\n      const textEncoder = new TextEncoder();\n      var that=this;\n      const transformer = new TransformStream({\n        transform(chunk, controller) {\n          const mocap = textEncoder.encode(that.mocapData);\n          that.mocapPrevData=that.mocapData;\n          that.mocapData=\"\";\n          const frame = chunk.data;\n          const data = new Uint8Array(chunk.data.byteLength + mocap.byteLength + that.CustomDatLengthByteCount + that.CustomDataDetector.length);\n          data.set(new Uint8Array(frame), 0);\n          data.set(mocap, frame.byteLength);\n          var bytes = that.getIntBytes(mocap.byteLength);\n          for (let i = 0; i < that.CustomDatLengthByteCount; i++) {\n            data[frame.byteLength + mocap.byteLength + i] = bytes[i];\n          }\n  \n          // Set magic string at the end\n          const magicIndex = frame.byteLength + mocap.byteLength + that.CustomDatLengthByteCount;\n          for (let i = 0; i < that.CustomDataDetector.length; i++) {\n            data[magicIndex + i] = that.CustomDataDetector.charCodeAt(i);\n          }\n          chunk.data = data.buffer;\n          controller.enqueue(chunk);\n        }\n      });\n  \n      streams.readable.pipeThrough(transformer).pipeTo(streams.writable);\n    } else {\n      var that=this;\n      const worker = new Worker('/dist/script-transform-worker.js');\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'registered') {\n          resolve();\n        }\n      });\n      const senderTransform = new RTCRtpScriptTransform(worker, { name: 'outgoing', port: that.senderChannel.port2 }, [that.senderChannel.port2]);\n      senderTransform.port = that.senderChannel.port1;\n      sender.transform = senderTransform;\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'started') {\n          resolve();\n        }\n      });\n\n      senderTransform.port.onmessage = e => {\n        if (e.data==\"CLEAR\") {\n          that.mocapPrevData=that.mocapData;\n          that.mocapData=\"\";\n        }       \n      }; \n   \n\n          \n      that.senderChannel.port1.postMessage({ watermark: that.mocapData });\n    }\n  }\n\n  async recreateDecoder(){\n    this.createDecoder(this.r_receiver,this.r_clientId);\n  }\n\n  async createDecoder(receiver,clientId) {\n    if (this.isChrome) {\n      const streams = receiver.createEncodedStreams();\n      const textDecoder = new TextDecoder();\n      var that=this;\n\n      const transformer = new TransformStream({\n        transform(chunk, controller) {\n          const view = new DataView(chunk.data);  \n          const magicData = new Uint8Array(chunk.data, chunk.data.byteLength - that.CustomDataDetector.length, that.CustomDataDetector.length);\n          let magic = [];\n          for (let i = 0; i < that.CustomDataDetector.length; i++) {\n            magic.push(magicData[i]);\n\n          }\n          let magicString = String.fromCharCode(...magic);\n          if (magicString === that.CustomDataDetector) {\n            const mocapLen = view.getUint32(chunk.data.byteLength - (that.CustomDatLengthByteCount + that.CustomDataDetector.length), false);\n            const frameSize = chunk.data.byteLength - (mocapLen + that.CustomDatLengthByteCount +  that.CustomDataDetector.length);\n            const mocapBuffer = new Uint8Array(chunk.data, frameSize, mocapLen);\n            const mocap = textDecoder.decode(mocapBuffer)        \n            if (mocap.length>0) {\n              window.remoteMocap(mocap+\",\"+clientId);\n            }\n            const frame = chunk.data;\n            chunk.data = new ArrayBuffer(frameSize);\n            const data = new Uint8Array(chunk.data);\n            data.set(new Uint8Array(frame, 0, frameSize));\n          }\n          controller.enqueue(chunk);\n        }\n      });\n      streams.readable.pipeThrough(transformer).pipeTo(streams.writable);\n    } else {\n      this.receiverChannel = new MessageChannel;\n      var that=this;\n      const worker = new Worker('/dist/script-transform-worker.js');\n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'registered') {\n          \n          resolve();\n        }\n      });\n  \n      const receiverTransform = new RTCRtpScriptTransform(worker, { name: 'incoming', port: that.receiverChannel.port2 }, [that.receiverChannel.port2]);\n\n      receiverTransform.port = that.receiverChannel.port1;\n      receiver.transform = receiverTransform;\n      receiverTransform.port.onmessage = e => {\n        if (e.data.length>0) {\n          window.remoteMocap(e.data+\",\"+clientId);\n        }\n      };\n  \n      await new Promise(resolve => worker.onmessage = (event) => {\n        if (event.data === 'started') {\n        //  console.warn(\"incoming 5a\",clientId,event.data );\n          resolve();\n        }\n     //   console.warn(\"incoming 5\",clientId,event.data );\n\n      });\n    //  console.warn(\"incoming 6\",clientId );\n    }\n  }  \n  sendData(clientId, dataType, data) {\n  //  console.log(\"BW73 sendData \", clientId, dataType, data);\n    // send via webrtc otherwise fallback to websockets\n    this.easyrtc.sendData(clientId, dataType, data);\n  }\n\n  sendDataGuaranteed(clientId, dataType, data) {\n  //  console.log(\"BW73 sendDataGuaranteed \", clientId, dataType, data);\n    this.easyrtc.sendDataWS(clientId, dataType, data);\n  }\n\n  broadcastData(dataType, data) {\n    return this.broadcastDataGuaranteed(dataType, data);\n    /*\n    console.log(\"BW73 broadcastData \", dataType, data);\n    var roomOccupants = this.easyrtc.getRoomOccupantsAsMap(this.room);\n\n    // Iterate over the keys of the easyrtc room occupants map.\n    // getRoomOccupantsAsArray uses Object.keys which allocates memory.\n    for (var roomOccupant in roomOccupants) {\n      if (roomOccupants[roomOccupant] && roomOccupant !== this.easyrtc.myEasyrtcid) {\n        // send via webrtc otherwise fallback to websockets\n        try {\n          this.easyrtc.sendData(roomOccupant, dataType, data);\n        } catch (e) {\n           console.error(\"sendData\",e);\n        }\n      }\n    }\n    */\n  }\n\n  broadcastDataGuaranteed(dataType, data) {\n   // console.log(\"BW73 broadcastDataGuaranteed \", dataType, data);\n    var destination = { targetRoom: this.room };\n    this.easyrtc.sendDataWS(destination, dataType, data);\n  }\n\n  getConnectStatus(clientId) {\n  //  console.log(\"BW73 getConnectStatus \", clientId);\n    var status = this.easyrtc.getConnectStatus(clientId);\n\n    if (status == this.easyrtc.IS_CONNECTED) {\n      return NAF.adapters.IS_CONNECTED;\n    } else if (status == this.easyrtc.NOT_CONNECTED) {\n      return NAF.adapters.NOT_CONNECTED;\n    } else {\n      return NAF.adapters.CONNECTING;\n    }\n  }\n\n  getMediaStream(clientId, streamName = \"audio\") {\n\n    console.log(\"BW73 getMediaStream \", clientId, streamName);\n    // if ( streamName = \"audio\") {\n    //streamName = \"bod_audio\";\n    //}\n\n    if (this.mediaStreams[clientId] && this.mediaStreams[clientId][streamName]) {\n      NAF.log.write(`Already had ${streamName} for ${clientId}`);\n      return Promise.resolve(this.mediaStreams[clientId][streamName]);\n    } else {\n      NAF.log.write(`Waiting on ${streamName} for ${clientId}`);\n\n      // Create initial pendingMediaRequests with audio|video alias\n      if (!this.pendingMediaRequests.has(clientId)) {\n        const pendingMediaRequests = {};\n\n        const audioPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.audio = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Audio Error`, e));\n\n        pendingMediaRequests.audio.promise = audioPromise;\n\n        const videoPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests.video = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream Video Error`, e));\n        pendingMediaRequests.video.promise = videoPromise;\n\n        this.pendingMediaRequests.set(clientId, pendingMediaRequests);\n      }\n\n      const pendingMediaRequests = this.pendingMediaRequests.get(clientId);\n\n      // Create initial pendingMediaRequests with streamName\n      if (!pendingMediaRequests[streamName]) {\n        const streamPromise = new Promise((resolve, reject) => {\n          pendingMediaRequests[streamName] = { resolve, reject };\n        }).catch(e => NAF.log.warn(`${clientId} getMediaStream \"${streamName}\" Error`, e));\n        pendingMediaRequests[streamName].promise = streamPromise;\n      }\n\n      return this.pendingMediaRequests.get(clientId)[streamName].promise;\n    }\n  }\n\n  setMediaStream(clientId, stream, streamName) {\n    console.log(\"BW73 setMediaStream \", clientId, stream, streamName);\n    const pendingMediaRequests = this.pendingMediaRequests.get(clientId); // return undefined if there is no entry in the Map\n    const clientMediaStreams = this.mediaStreams[clientId] = this.mediaStreams[clientId] || {};\n\n    if (streamName === 'default') {\n      // Safari doesn't like it when you use a mixed media stream where one of the tracks is inactive, so we\n      // split the tracks into two streams.\n      // Add mediaStreams audio streamName alias\n      const audioTracks = stream.getAudioTracks();\n      if (audioTracks.length > 0) {\n        const audioStream = new MediaStream();\n        try {\n          audioTracks.forEach(track => audioStream.addTrack(track));\n          clientMediaStreams.audio = audioStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"audio\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream audio alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      // Add mediaStreams video streamName alias\n      const videoTracks = stream.getVideoTracks();\n      if (videoTracks.length > 0) {\n        const videoStream = new MediaStream();\n        try {\n          videoTracks.forEach(track => videoStream.addTrack(track));\n          clientMediaStreams.video = videoStream;\n        } catch (e) {\n          NAF.log.warn(`${clientId} setMediaStream \"video\" alias Error`, e);\n        }\n\n        // Resolve the promise for the user's media stream video alias if it exists.\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n      }\n    } else {\n      clientMediaStreams[streamName] = stream;\n\n      // Resolve the promise for the user's media stream by StreamName if it exists.\n      if (pendingMediaRequests && pendingMediaRequests[streamName]) {\n        pendingMediaRequests[streamName].resolve(stream);\n      }\n    }\n  }\n\n  getIntBytes(x) {\n    var bytes = [];\n    var i = this.CustomDatLengthByteCount;\n    do {\n      bytes[--i] = x & (255);\n      x = x >> 8;\n    } while (i)\n    return bytes;\n  }\n\n  addLocalMediaStream(stream, streamName) {\n    console.log(\"BW73 addLocalMediaStream \", stream, streamName);\n    const easyrtc = this.easyrtc;\n    streamName = streamName || stream.id;\n    this.setMediaStream(\"local\", stream, streamName);\n    easyrtc.register3rdPartyLocalMediaStream(stream, streamName);\n\n    // Add local stream to existing connections\n    Object.keys(this.remoteClients).forEach(clientId => {\n      if (easyrtc.getConnectStatus(clientId) !== easyrtc.NOT_CONNECTED) {\n        easyrtc.addStreamToCall(clientId, streamName);\n      }\n    });\n  }\n\n  removeLocalMediaStream(streamName) {\n    console.log(\"BW73 removeLocalMediaStream \", streamName);\n    this.easyrtc.closeLocalMediaStream(streamName);\n    delete this.mediaStreams[\"local\"][streamName];\n  }\n\n  enableMicrophone(enabled) {\n    console.log(\"BW73 enableMicrophone \", enabled);\n    this.easyrtc.enableMicrophone(enabled);\n  }\n\n  enableCamera(enabled) {\n    console.log(\"BW73 enableCamera \", enabled);\n    this.easyrtc.enableCamera(enabled);\n  }\n\n  disconnect() {\n    console.log(\"BW73 disconnect \");\n    this.easyrtc.disconnect();\n  }\n\n  async handleUserPublished(user, mediaType) { }\n\n  handleUserUnpublished(user, mediaType) {\n    console.log(\"BW73 handleUserUnPublished \");\n  }\n\n   getInputLevel(track) {\n    var analyser = track._source.volumeLevelAnalyser.analyserNode;\n    //var analyser = track._source.analyserNode;\n    const bufferLength = analyser.frequencyBinCount;\n    var data = new Uint8Array(bufferLength);\n    analyser.getByteFrequencyData(data);\n    var values = 0;\n    var average;\n    var length = data.length;\n    for (var i = 0; i < length; i++) {\n      values += data[i];\n    }\n    average = Math.floor(values / length);\n    return average;\n  }\n\n   voiceActivityDetection() {\n    if (!this._vad_audioTrack || !this._vad_audioTrack._enabled)\n      return;\n\n    var audioLevel = this.getInputLevel(this._vad_audioTrack);\n    if (audioLevel <= this._vad_MaxBackgroundNoiseLevel) {\n      if (this._vad_audioSamplesArr.length >= this._vad_MaxAudioSamples) {\n        var removed = this._vad_audioSamplesArr.shift();\n        var removedIndex = this._vad_audioSamplesArrSorted.indexOf(removed);\n        if (removedIndex > -1) {\n          this._vad_audioSamplesArrSorted.splice(removedIndex, 1);\n        }\n      }\n      this._vad_audioSamplesArr.push(audioLevel);\n      this._vad_audioSamplesArrSorted.push(audioLevel);\n      this._vad_audioSamplesArrSorted.sort((a, b) => a - b);\n    }\n    var background = Math.floor(3 * this._vad_audioSamplesArrSorted[Math.floor(this._vad_audioSamplesArrSorted.length / 2)] / 2);\n    if (audioLevel > background + this._vad_SilenceOffeset) {\n      this._vad_exceedCount++;\n    } else {\n      this._vad_exceedCount = 0;\n    }\n\n    if (this._vad_exceedCount > this._vad_exceedCountThresholdLow) {\n      //AgoraRTCUtilEvents.emit(\"VoiceActivityDetectedFast\", this._vad_exceedCount);\n      window._state_stop_at=Date.now();\n     // console.error(\"VADl \",Date.now()-window._state_stop_at);\n    }\n\n    if (this._vad_exceedCount > this._vad_exceedCountThreshold) {\n      //AgoraRTCUtilEvents.emit(\"VoiceActivityDetected\", this._vad_exceedCount);\n      this._vad_exceedCount = 0;\n      window._state_stop_at=Date.now();\n   //   console.error(\"VAD \",Date.now()-window._state_stop_at);\n    }\n\n  }\n\n  async connectAgora() {\n    // Add an event listener to play remote tracks when remote user publishes.\n    var that = this;\n\n    this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    if (this.enableVideoFiltered || this.enableVideo || this.enableAudio) {\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"rtc\", codec: \"vp8\" });\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"h264\" });\n      this.agoraClient.setClientRole(\"host\");\n    } else {\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"h264\" });\n      //this.agoraClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n    }\n\n    this.agoraClient.on(\"user-joined\", async (user) => {\n      console.warn(\"user-joined\", user);\n    });\n    this.agoraClient.on(\"user-published\", async (user, mediaType) => {\n\n      let clientId = user.uid;\n      console.log(\"BW73 handleUserPublished \" + clientId + \" \" + mediaType, that.agoraClient);\n      await that.agoraClient.subscribe(user, mediaType);\n      console.log(\"BW73 handleUserPublished2 \" + clientId + \" \" + that.agoraClient);\n\n      const pendingMediaRequests = that.pendingMediaRequests.get(clientId);\n      const clientMediaStreams = that.mediaStreams[clientId] = that.mediaStreams[clientId] || {};\n\n      if (mediaType === 'audio') {\n        user.audioTrack.play();\n\n        const audioStream = new MediaStream();\n        console.log(\"user.audioTrack \", user.audioTrack._mediaStreamTrack);\n        //audioStream.addTrack(user.audioTrack._mediaStreamTrack);\n        clientMediaStreams.audio = audioStream;\n        if (pendingMediaRequests) pendingMediaRequests.audio.resolve(audioStream);\n      }\n\n      let videoStream = null;\n      if (mediaType === 'video') {\n        videoStream = new MediaStream();\n        console.log(\"user.videoTrack \", user.videoTrack._mediaStreamTrack);\n        videoStream.addTrack(user.videoTrack._mediaStreamTrack);\n        clientMediaStreams.video = videoStream;\n        if (pendingMediaRequests) pendingMediaRequests.video.resolve(videoStream);\n        //user.videoTrack\n      }\n\n      if (clientId == 'CCC') {\n        if (mediaType === 'video') {\n          // document.getElementById(\"video360\").srcObject=videoStream;\n          //document.querySelector(\"#video360\").setAttribute(\"src\", videoStream);\n          //document.querySelector(\"#video360\").setAttribute(\"src\", user.videoTrack._mediaStreamTrack);\n          //document.querySelector(\"#video360\").srcObject= user.videoTrack._mediaStreamTrack;\n          document.querySelector(\"#video360\").srcObject = videoStream;\n          document.querySelector(\"#video360\").play();\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n      if (clientId == 'DDD') {\n        if (mediaType === 'video') {\n          user.videoTrack.play(\"video360\");\n        }\n        if (mediaType === 'audio') {\n          user.audioTrack.play();\n        }\n      }\n\n\n      let enc_id='na';\n      if (mediaType === 'audio') {\n        enc_id=user.audioTrack._mediaStreamTrack.id;       \n      } else {\n       // enc_id=user.videoTrack._mediaStreamTrack.id;\n      }\n    \n      //console.warn(mediaType,enc_id);    \n      const pc =this.agoraClient._p2pChannel.connection.peerConnection;\n      const receivers = pc.getReceivers();  \n      for (let i = 0; i < receivers.length; i++) {\n        if (receivers[i].track && receivers[i].track.id===enc_id ) {\n          console.warn(\"Match\",mediaType,enc_id);\n          this.r_receiver=receivers[i];\n          this.r_clientId=clientId;\n          this.createDecoder(this.r_receiver,this.r_clientId);\n      }\n    }\n    \n    });\n\n    this.agoraClient.on(\"user-unpublished\", that.handleUserUnpublished);\n\n    console.log(\"connect agora \");\n    // Join a channel and create local tracks. Best practice is to use Promise.all and run them concurrently.\n    // o\n\n\n    if (this.enableAvatar) {\n      var stream = document.getElementById(\"canvas\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideoFiltered && this.enableAudio) {\n      var stream = document.getElementById(\"canvas_secret\").captureStream(30);\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTracks()[0] })]);\n    }\n    else if (this.enableVideo && this.enableAudio) {\n      [this.userid, this.localTracks.audioTrack, this.localTracks.videoTrack] = await Promise.all([\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null),\n        AgoraRTC.createMicrophoneAudioTrack(), AgoraRTC.createCameraVideoTrack({ encoderConfig: '480p_2' })]);\n    } else if (this.enableVideo) {\n      [this.userid, this.localTracks.videoTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), AgoraRTC.createCameraVideoTrack(\"360p_4\")]);\n    } else if (this.enableAudio) {\n      let audio_track;\n      if (window.gum_stream) { // avoid double allow iOs\n        \n        audio_track=AgoraRTC.createCustomAudioTrack({ mediaStreamTrack: window.gum_stream.getAudioTracks()[0]});\n        console.warn(audio_track,\"audio_track\");\n      }\n      else {\n        audio_track=AgoraRTC.createMicrophoneAudioTrack()\n      }\n      \n      [this.userid, this.localTracks.audioTrack] = await Promise.all([\n        // Join the channel.\n        this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null), audio_track]);\n        //console.log(\"createMicrophoneAudioTrack\");\n        this._vad_audioTrack = this.localTracks.audioTrack;\n        if (!this._voiceActivityDetectionInterval) {\n          this._voiceActivityDetectionInterval = setInterval(() => {\n            this.voiceActivityDetection();\n          }, this._voiceActivityDetectionFrequency);\n        }\n        \n    } else {\n      this.userid = await this.agoraClient.join(this.appid, this.room, this.token || null, this.clientId || null);\n    }\n\n\n    // select facetime camera if exists\n    if (this.enableVideo && !this.enableVideoFiltered) {\n      let cams = await AgoraRTC.getCameras();\n      for (var i = 0; i < cams.length; i++) {\n        if (cams[i].label.indexOf(\"FaceTime\") == 0) {\n          console.log(\"select FaceTime camera\", cams[i].deviceId);\n          await this.localTracks.videoTrack.setDevice(cams[i].deviceId);\n        }\n      }\n    }\n\n    if (this.enableVideo && this.showLocal) {\n      this.localTracks.videoTrack.play(\"local-player\");\n    }\n\n    // Enable virtual background OLD Method\n    if (this.enableVideo && this.vbg0 && this.localTracks.videoTrack) {\n      const imgElement = document.createElement('img');\n      imgElement.onload = async () => {\n        if (!this.virtualBackgroundInstance) {\n          console.log(\"SEG INIT \", this.localTracks.videoTrack);\n          this.virtualBackgroundInstance = await SegPlugin.inject(this.localTracks.videoTrack, \"/assets/wasms0\").catch(console.error);\n          console.log(\"SEG INITED\");\n        }\n        this.virtualBackgroundInstance.setOptions({ enable: true, background: imgElement });\n      };\n      imgElement.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAAD0lEQVR4XmNg+M+AQDg5AOk9C/VkomzYAAAAAElFTkSuQmCC';\n    }\n\n    // Enable virtual background New Method\n    if (this.enableVideo && this.vbg && this.localTracks.videoTrack) {\n\n      this.extension = new VirtualBackgroundExtension();\n      AgoraRTC.registerExtensions([this.extension]);\n      this.processor = this.extension.createProcessor();\n      await this.processor.init(\"/assets/wasms\");\n      this.localTracks.videoTrack.pipe(this.processor).pipe(this.localTracks.videoTrack.processorDestination);\n      await this.processor.setOptions({ type: 'color', color: \"#00ff00\" });\n      await this.processor.enable();\n    }\n\n    window.localTracks = this.localTracks;\n\n    // Publish the local video and audio tracks to the channel.\n    if (this.enableVideo || this.enableAudio || this.enableAvatar) {\n      if (this.localTracks.audioTrack)\n        await this.agoraClient.publish(this.localTracks.audioTrack);\n      if (this.localTracks.videoTrack)\n        await this.agoraClient.publish(this.localTracks.videoTrack);\n\n      console.log(\"publish success\");\n      const pc =this.agoraClient._p2pChannel.connection.peerConnection;\n      const senders = pc.getSenders();\n      let i = 0;\n      for (i = 0; i < senders.length; i++) {\n        if (senders[i].track && (senders[i].track.kind == 'audio')){//} || senders[i].track.kind == 'video' )) {\n          this.createEncoder(senders[i]);\n        }\n      }      \n    }\n\n    // RTM\n\n  }\n\n  /**\n   * Privates\n   */\n\n  async _connect(connectSuccess, connectFailure) {\n    var that = this;\n    await that.easyrtc.connect(that.app, connectSuccess, connectFailure);\n  }\n\n  _getRoomJoinTime(clientId) {\n    var myRoomId = this.room; //NAF.room;\n    var joinTime = this.easyrtc.getRoomOccupantsAsMap(myRoomId)[clientId].roomJoinTime;\n    return joinTime;\n  }\n\n  getServerTime() {\n    return Date.now() + this.avgTimeOffset;\n  }\n}\n\nNAF.adapters.register(\"agorartc\", AgoraRtcAdapter);\n\nmodule.exports = AgoraRtcAdapter;\n"],"sourceRoot":""}