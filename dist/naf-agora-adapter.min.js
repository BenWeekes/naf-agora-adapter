!function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t){class a{constructor(e){console.log("BW73 constructor ",e),this.easyrtc=e||window.easyrtc,this.app="default",this.room="default",this.userid=0,this.appid=null,this.mediaStreams={},this.remoteClients={},this.pendingMediaRequests=new Map,this.enableVideo=!1,this.enableVideoFiltered=!1,this.enableAudio=!1,this.enableAvatar=!1,this.localTracks={videoTrack:null,audioTrack:null},window.localTracks=this.localTracks,console.error("ASS ",window.localTracks),this.token=null,this.clientId=null,this.uid=null,this.vbg=!1,this.vbg0=!1,this.showLocal=!1,this.virtualBackgroundInstance=null,this.extension=null,this.processor=null,this.pipeProcessor=(e,t)=>{e.pipe(t).pipe(e.processorDestination)},this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0,this.agoraClient=null,this.easyrtc.setPeerOpenListener(e=>{const t=this.easyrtc.getPeerConnectionByUserId(e);this.remoteClients[e]=t}),this.easyrtc.setPeerClosedListener(e=>{delete this.remoteClients[e]})}setServerUrl(e){console.log("BW73 setServerUrl ",e),this.easyrtc.setSocketUrl(e)}setApp(e){console.log("BW73 setApp ",e),this.app=e,this.appid=e}async setRoom(e){e=e.replace(/'/g,'"');const t=JSON.parse(e);this.room=t.name,t.vbg&&"true"==t.vbg&&(this.vbg=!0),t.vbg0&&"true"==t.vbg0&&(this.vbg0=!0,AgoraRTC.loadModule(SegPlugin,{})),t.enableAvatar&&"true"==t.enableAvatar&&(this.enableAvatar=!0),t.showLocal&&"true"==t.showLocal&&(this.showLocal=!0),t.enableVideoFiltered&&"true"==t.enableVideoFiltered&&(this.enableVideoFiltered=!0),this.easyrtc.joinRoom(this.room,null)}setWebRtcOptions(e){console.log("BW73 setWebRtcOptions ",e),this.easyrtc.enableDataChannels(e.datachannel),this.enableVideo=e.video,this.enableAudio=e.audio,this.easyrtc.enableVideo(!1),this.easyrtc.enableAudio(!1),this.easyrtc.enableVideoReceive(!1),this.easyrtc.enableAudioReceive(!1)}setServerConnectListeners(e,t){console.log("BW73 setServerConnectListeners ",e,t),this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){console.log("BW73 setRoomOccupantListener ",e),this.easyrtc.setRoomOccupantListener((function(t,a,s){e(a)}))}setDataChannelListeners(e,t,a){console.log("BW73 setDataChannelListeners  ",e,t,a),this.easyrtc.setDataChannelOpenListener(e),this.easyrtc.setDataChannelCloseListener(t),this.easyrtc.setPeerListener(a)}updateTimeOffset(){console.log("BW73 updateTimeOffset ");const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then(t=>{var a=new Date(t.headers.get("Date")).getTime()+500,s=Date.now(),i=a+(s-e)/2-s;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(i):this.timeOffsets[this.serverTimeRequests%10]=i,this.avgTimeOffset=this.timeOffsets.reduce((e,t)=>e+t,0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout(()=>this.updateTimeOffset(),3e5):this.updateTimeOffset()})}connect(){console.log("BW73 connect "),Promise.all([this.updateTimeOffset(),new Promise((e,t)=>{this._connect(e,t)})]).then(([e,t])=>{console.log("BW73 connected "+t),this.clientId=t,this._myRoomJoinTime=this._getRoomJoinTime(t),this.connectAgora(),this.connectSuccess(t)}).catch(this.connectFailure)}shouldStartConnectionTo(e){return this._myRoomJoinTime<=e.roomJoinTime}startStreamConnection(e){console.log("BW73 startStreamConnection ",e),this.easyrtc.call(e,(function(e,t){"datachannel"===t&&NAF.log.write("Successfully started datachannel to ",e)}),(function(e,t){NAF.log.error(e,t)}),(function(e){}))}closeStreamConnection(e){console.log("BW73 closeStreamConnection ",e),this.easyrtc.hangup(e)}sendData(e,t,a){console.log("BW73 sendData ",e,t,a),this.easyrtc.sendData(e,t,a)}sendDataGuaranteed(e,t,a){console.log("BW73 sendDataGuaranteed ",e,t,a),this.easyrtc.sendDataWS(e,t,a)}broadcastData(e,t){console.log("BW73 broadcastData ",e,t);var a=this.easyrtc.getRoomOccupantsAsMap(this.room);for(var s in a)a[s]&&s!==this.easyrtc.myEasyrtcid&&this.easyrtc.sendData(s,e,t)}broadcastDataGuaranteed(e,t){console.log("BW73 broadcastDataGuaranteed ",e,t);var a={targetRoom:this.room};this.easyrtc.sendDataWS(a,e,t)}getConnectStatus(e){console.log("BW73 getConnectStatus ",e);var t=this.easyrtc.getConnectStatus(e);return t==this.easyrtc.IS_CONNECTED?NAF.adapters.IS_CONNECTED:t==this.easyrtc.NOT_CONNECTED?NAF.adapters.NOT_CONNECTED:NAF.adapters.CONNECTING}getMediaStream(e,t="audio"){if(console.log("BW73 getMediaStream ",e,t),this.mediaStreams[e]&&this.mediaStreams[e][t])return NAF.log.write(`Already had ${t} for ${e}`),Promise.resolve(this.mediaStreams[e][t]);{if(NAF.log.write(`Waiting on ${t} for ${e}`),!this.pendingMediaRequests.has(e)){const t={},a=new Promise((e,a)=>{t.audio={resolve:e,reject:a}}).catch(t=>NAF.log.warn(e+" getMediaStream Audio Error",t));t.audio.promise=a;const s=new Promise((e,a)=>{t.video={resolve:e,reject:a}}).catch(t=>NAF.log.warn(e+" getMediaStream Video Error",t));t.video.promise=s,this.pendingMediaRequests.set(e,t)}const a=this.pendingMediaRequests.get(e);if(!a[t]){const s=new Promise((e,s)=>{a[t]={resolve:e,reject:s}}).catch(a=>NAF.log.warn(`${e} getMediaStream "${t}" Error`,a));a[t].promise=s}return this.pendingMediaRequests.get(e)[t].promise}}setMediaStream(e,t,a){console.log("BW73 setMediaStream ",e,t,a);const s=this.pendingMediaRequests.get(e),i=this.mediaStreams[e]=this.mediaStreams[e]||{};if("default"===a){const a=t.getAudioTracks();if(a.length>0){const t=new MediaStream;try{a.forEach(e=>t.addTrack(e)),i.audio=t}catch(t){NAF.log.warn(e+' setMediaStream "audio" alias Error',t)}s&&s.audio.resolve(t)}const o=t.getVideoTracks();if(o.length>0){const t=new MediaStream;try{o.forEach(e=>t.addTrack(e)),i.video=t}catch(t){NAF.log.warn(e+' setMediaStream "video" alias Error',t)}s&&s.video.resolve(t)}}else i[a]=t,s&&s[a]&&s[a].resolve(t)}addLocalMediaStream(e,t){console.log("BW73 addLocalMediaStream ",e,t);const a=this.easyrtc;t=t||e.id,this.setMediaStream("local",e,t),a.register3rdPartyLocalMediaStream(e,t),Object.keys(this.remoteClients).forEach(e=>{a.getConnectStatus(e)!==a.NOT_CONNECTED&&a.addStreamToCall(e,t)})}removeLocalMediaStream(e){console.log("BW73 removeLocalMediaStream ",e),this.easyrtc.closeLocalMediaStream(e),delete this.mediaStreams.local[e]}enableMicrophone(e){console.log("BW73 enableMicrophone ",e),this.easyrtc.enableMicrophone(e)}enableCamera(e){console.log("BW73 enableCamera ",e),this.easyrtc.enableCamera(e)}disconnect(){console.log("BW73 disconnect "),this.easyrtc.disconnect()}async handleUserPublished(e,t){}handleUserUnpublished(e,t){console.log("BW73 handleUserUnPublished ")}async connectAgora(){var e=this;if(this.agoraClient=AgoraRTC.createClient({mode:"live",codec:"vp8"}),(this.enableVideoFiltered||this.enableVideo||this.enableAudio)&&this.agoraClient.setClientRole("host"),this.agoraClient.on("user-joined",async e=>{console.warn("user-joined",e)}),this.agoraClient.on("user-published",async(t,a)=>{let s=t.uid;console.log("BW73 handleUserPublished "+s+" "+a,e.agoraClient),await e.agoraClient.subscribe(t,a),console.log("BW73 handleUserPublished2 "+s+" "+e.agoraClient);const i=e.pendingMediaRequests.get(s),o=e.mediaStreams[s]=e.mediaStreams[s]||{};if("audio"===a){t.audioTrack.play();const e=new MediaStream;console.log("user.audioTrack ",t.audioTrack._mediaStreamTrack),o.audio=e,i&&i.audio.resolve(e)}let r=null;"video"===a&&(r=new MediaStream,console.log("user.videoTrack ",t.videoTrack._mediaStreamTrack),r.addTrack(t.videoTrack._mediaStreamTrack),o.video=r,i&&i.video.resolve(r)),"CCC"==s&&("video"===a&&(document.querySelector("#video360").srcObject=r,document.querySelector("#video360").play()),"audio"===a&&t.audioTrack.play()),"DDD"==s&&("video"===a&&t.videoTrack.play("video360"),"audio"===a&&t.audioTrack.play())}),this.agoraClient.on("user-unpublished",e.handleUserUnpublished),console.log("connect agora "),this.enableAvatar){var t=document.getElementById("canvas").captureStream(30);[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCustomVideoTrack({mediaStreamTrack:t.getVideoTracks()[0]})])}else if(this.enableVideoFiltered&&this.enableAudio){t=document.getElementById("canvas_secret").captureStream(30);[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCustomVideoTrack({mediaStreamTrack:t.getVideoTracks()[0]})])}else this.enableVideo&&this.enableAudio?[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCameraVideoTrack({encoderConfig:"480p_2"})]):this.enableVideo?[this.userid,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createCameraVideoTrack("360p_4")]):this.enableAudio?[this.userid,this.localTracks.audioTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack()]):this.userid=await this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null);if(this.enableVideo&&!this.enableVideoFiltered){let e=await AgoraRTC.getCameras();for(var a=0;a<e.length;a++)0==e[a].label.indexOf("FaceTime")&&(console.log("select FaceTime camera",e[a].deviceId),await this.localTracks.videoTrack.setDevice(e[a].deviceId))}if(this.enableVideo&&this.showLocal&&this.localTracks.videoTrack.play("local-player"),this.enableVideo&&this.vbg0&&this.localTracks.videoTrack){const e=document.createElement("img");e.onload=async()=>{this.virtualBackgroundInstance||(console.log("SEG INIT ",this.localTracks.videoTrack),this.virtualBackgroundInstance=await SegPlugin.inject(this.localTracks.videoTrack,"/assets/wasms0").catch(console.error),console.log("SEG INITED")),this.virtualBackgroundInstance.setOptions({enable:!0,background:e})},e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAAD0lEQVR4XmNg+M+AQDg5AOk9C/VkomzYAAAAAElFTkSuQmCC"}this.enableVideo&&this.vbg&&this.localTracks.videoTrack&&(this.extension=new VirtualBackgroundExtension,AgoraRTC.registerExtensions([this.extension]),this.processor=this.extension.createProcessor(),await this.processor.init("/assets/wasms"),this.localTracks.videoTrack.pipe(this.processor).pipe(this.localTracks.videoTrack.processorDestination),await this.processor.setOptions({type:"color",color:"#00ff00"}),await this.processor.enable()),window.localTracks=this.localTracks,console.error("ASS 2 ",window.localTracks),(this.enableVideo||this.enableAudio||this.enableAvatar)&&(await this.agoraClient.publish(Object.values(this.localTracks)),console.log("publish success"))}async _connect(e,t){await this.easyrtc.connect(this.app,e,t)}_getRoomJoinTime(e){var t=this.room;return this.easyrtc.getRoomOccupantsAsMap(t)[e].roomJoinTime}getServerTime(){return Date.now()+this.avgTimeOffset}}NAF.adapters.register("agorartc",a),e.exports=a}]);
//# sourceMappingURL=naf-agora-adapter.min.js.map