!function(e){var t={};function a(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(i,s,function(t){return e[t]}.bind(null,s));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t){class a{constructor(e){if(console.log("BW73 constructor ",e),this.easyrtc=e||window.easyrtc,this.app="default",this.room="default",this.userid=0,this.appid=null,this.mocapData="",this.mocapPrevData="",this.logi=0,this.logo=0,this.mediaStreams={},this.remoteClients={},this.occupantList={},this.audioJitter={},this.pendingMediaRequests=new Map,this.enableVideo=!1,this.enableVideoFiltered=!1,this.enableAudio=!1,this.enableAvatar=!1,this.localTracks={videoTrack:null,audioTrack:null},window.localTracks=this.localTracks,this.token=null,this.clientId=null,this.uid=null,this.vbg=!1,this.vbg0=!1,this.showLocal=!1,this.virtualBackgroundInstance=null,this.extension=null,this.processor=null,this.pipeProcessor=(e,t)=>{e.pipe(t).pipe(e.processorDestination)},this.serverTimeRequests=0,this.timeOffsets=[],this.avgTimeOffset=0,this.agoraClient=null,this.agoraRTM=!1,this.agoraRTM2=!1,this.rtmClient=null,this.rtmUid=null,this.rtmChannelName=null,this.rtmChannel=null,this.easyrtc.setPeerOpenListener(e=>{const t=this.easyrtc.getPeerConnectionByUserId(e);this.remoteClients[e]=t}),this.easyrtc.setPeerClosedListener(e=>{delete this.remoteClients[e]}),this.isChrome=-1===navigator.userAgent.indexOf("Firefox")&&navigator.userAgent.indexOf("Chrome")>-1,this.isChrome){window.oldRTCPeerConnection=RTCPeerConnection,window.RTCPeerConnection=new Proxy(window.RTCPeerConnection,{construct:function(e,t){t.length>0?t[0].encodedInsertableStreams=!0:t.push({encodedInsertableStreams:!0});return new window.oldRTCPeerConnection(...t)}});const e=window.RTCPeerConnection.prototype.setConfiguration;window.RTCPeerConnection.prototype.setConfiguration=function(){const t=arguments;t.length>0?t[0].encodedInsertableStreams=!0:t.push({encodedInsertableStreams:!0}),e.apply(this,t)}}this.CustomDataDetector="AGORAMOCAP",this.CustomDatLengthByteCount=4,this.senderChannel=new MessageChannel,this.receiverChannel,this._vad_audioTrack=null,this._voiceActivityDetectionFrequency=150,this._vad_MaxAudioSamples=400,this._vad_MaxBackgroundNoiseLevel=20,this._vad_SilenceOffeset=4,this._vad_audioSamplesArr=[],this._vad_audioSamplesArrSorted=[],this._vad_exceedCount=0,this._vad_exceedCountThreshold=2,this._vad_exceedCountThresholdLow=1,this._voiceActivityDetectionInterval,window.AgoraRtcAdapter=this}setServerUrl(e){console.log("BW73 setServerUrl ",e),this.easyrtc.setSocketUrl(e)}setApp(e){console.log("BW73 setApp ",e),this.app=e,this.appid=e}async setRoom(e){e=e.replace(/'/g,'"');const t=JSON.parse(e);this.room=t.name,t.vbg&&"true"==t.vbg&&(this.vbg=!0),t.vbg0&&"true"==t.vbg0&&(this.vbg0=!0,AgoraRTC.loadModule(SegPlugin,{})),t.enableAvatar&&"true"==t.enableAvatar&&(this.enableAvatar=!0),t.agoraRTM&&"true"==t.agoraRTM&&(this.agoraRTM=!0),t.agoraRTM2&&"true"==t.agoraRTM2&&(this.agoraRTM2=!0),t.showLocal&&"true"==t.showLocal&&(this.showLocal=!0),t.enableVideoFiltered&&"true"==t.enableVideoFiltered&&(this.enableVideoFiltered=!0),this.agoraRTM||this.easyrtc.joinRoom(this.room,null)}setWebRtcOptions(e){console.log("BW73 setWebRtcOptions ",e),this.easyrtc.enableDataChannels(e.datachannel),this.enableVideo=e.video,this.enableAudio=e.audio,this.easyrtc.enableVideo(!1),this.easyrtc.enableAudio(!1),this.easyrtc.enableVideoReceive(!1),this.easyrtc.enableAudioReceive(!1)}setServerConnectListeners(e,t){console.log("BW73 setServerConnectListeners ",e,t),this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){console.log("BW73 setRoomOccupantListener ",e),this.occupantListener=e,this.easyrtc.setRoomOccupantListener((function(t,a,i){e(a)}))}setDataChannelListeners(e,t,a){console.log("BW73 setDataChannelListeners  ",e,t,a),this.easyrtc.setDataChannelOpenListener(e),this.easyrtc.setDataChannelCloseListener(t),this.easyrtc.setPeerListener(a),this.openListener=e,this.messageListener=a,this.closedListener=t}updateTimeOffset(){console.log("BW73 updateTimeOffset ");const e=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then(t=>{var a=new Date(t.headers.get("Date")).getTime()+500,i=Date.now(),s=a+(i-e)/2-i;this.serverTimeRequests++,this.serverTimeRequests<=10?this.timeOffsets.push(s):this.timeOffsets[this.serverTimeRequests%10]=s,this.avgTimeOffset=this.timeOffsets.reduce((e,t)=>e+t,0)/this.timeOffsets.length,this.serverTimeRequests>10?setTimeout(()=>this.updateTimeOffset(),3e5):this.updateTimeOffset()})}connect(){console.log("BW73 connect "),Promise.all([this.updateTimeOffset(),new Promise((e,t)=>{this.agoraRTM?(this.clientId=this.generateId(10),this.connectAgora(e,t)):this._connect(e,t)})]).then(([e,t])=>{console.log("BW73 connected "+t),this.clientId=t,this.agoraRTM||(this._myRoomJoinTime=this._getRoomJoinTime(t),this.connectAgora()),this.connectSuccess(t)}).catch(this.connectFailure)}shouldStartConnectionTo(e){return this._myRoomJoinTime<=e.roomJoinTime}startStreamConnection(e){console.error("BW73 startStreamConnection ",e),this.easyrtc.call(e,(function(e,t){"datachannel"===t&&NAF.log.write("Successfully started datachannel to ",e)}),(function(e,t){NAF.log.error(e,t)}),(function(e){}))}closeStreamConnection(e){console.info("BW73 closeStreamConnection ",e),this.agoraRTM?this.closedListener(e):this.easyrtc.hangup(e)}sendMocap(e){e==this.mocapPrevData&&(e=""),""===this.mocapData&&(this.mocapData=e),this.isChrome||this.senderChannel.port1.postMessage({watermark:e})}async createEncoder(e){if(this.isChrome){const a=e.createEncodedStreams(),i=new TextEncoder;var t=this;const s=new TransformStream({transform(e,a){const s=i.encode(t.mocapData);t.mocapPrevData=t.mocapData,t.mocapData="";const o=e.data,r=new Uint8Array(e.data.byteLength+s.byteLength+t.CustomDatLengthByteCount+t.CustomDataDetector.length);r.set(new Uint8Array(o),0),r.set(s,o.byteLength);var n=t.getIntBytes(s.byteLength);for(let e=0;e<t.CustomDatLengthByteCount;e++)r[o.byteLength+s.byteLength+e]=n[e];const c=o.byteLength+s.byteLength+t.CustomDatLengthByteCount;for(let e=0;e<t.CustomDataDetector.length;e++)r[c+e]=t.CustomDataDetector.charCodeAt(e);e.data=r.buffer,a.enqueue(e)}});a.readable.pipeThrough(s).pipeTo(a.writable)}else{t=this;const a=new Worker("/dist/script-transform-worker.js");await new Promise(e=>a.onmessage=t=>{"registered"===t.data&&e()});const i=new RTCRtpScriptTransform(a,{name:"outgoing",port:t.senderChannel.port2},[t.senderChannel.port2]);i.port=t.senderChannel.port1,e.transform=i,await new Promise(e=>a.onmessage=t=>{"started"===t.data&&e()}),i.port.onmessage=e=>{"CLEAR"==e.data&&(t.mocapPrevData=t.mocapData,t.mocapData="")},t.senderChannel.port1.postMessage({watermark:t.mocapData})}}async createDecoder(e,t){if(this.isChrome){const i=e.createEncodedStreams(),s=new TextDecoder;var a=this;const o=new TransformStream({transform(e,i){const o=new DataView(e.data),r=new Uint8Array(e.data,e.data.byteLength-a.CustomDataDetector.length,a.CustomDataDetector.length);let n=[];for(let e=0;e<a.CustomDataDetector.length;e++)n.push(r[e]);if(String.fromCharCode(...n)===a.CustomDataDetector){const i=o.getUint32(e.data.byteLength-(a.CustomDatLengthByteCount+a.CustomDataDetector.length),!1),r=e.data.byteLength-(i+a.CustomDatLengthByteCount+a.CustomDataDetector.length),n=new Uint8Array(e.data,r,i),c=s.decode(n);c.length>0&&window.remoteMocap(c+","+t);const l=e.data;e.data=new ArrayBuffer(r);new Uint8Array(e.data).set(new Uint8Array(l,0,r))}i.enqueue(e)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else{this.receiverChannel=new MessageChannel;a=this;const i=new Worker("/dist/script-transform-worker.js");await new Promise(e=>i.onmessage=t=>{"registered"===t.data&&e()});const s=new RTCRtpScriptTransform(i,{name:"incoming",port:a.receiverChannel.port2},[a.receiverChannel.port2]);s.port=a.receiverChannel.port1,e.transform=s,s.port.onmessage=e=>{e.data.length>0&&window.remoteMocap(e.data+","+t)},await new Promise(e=>i.onmessage=t=>{"started"===t.data&&e()})}}async readStats(){if(this.agoraClient._users)for(var e=0;e<this.agoraClient._users.length;e++)this.agoraClient._users[e].audioTrack&&this.agoraClient._users[e].audioTrack._mediaStreamTrack&&await this.agoraClient._p2pChannel.connection.peerConnection.getStats(this.agoraClient._users[e].audioTrack._mediaStreamTrack).then(async t=>{await t.forEach(t=>{if("inbound-rtp"===t.type&&"audio"===t.kind){var a=(t.jitterBufferDelay/t.jitterBufferEmittedCount).toFixed(3);isNaN(a)?this.audioJitter[this.agoraClient._users[e].uid]=80:this.audioJitter[this.agoraClient._users[e].uid]=1e3*a}})})}handleRTM(e,t){const a=JSON.parse(t);console.log("BW75 handleRTM",e,a),window.AgoraRtcAdapter.messageListener(e,a.dataType,a.data)}handleRTM2(e,t){const a=JSON.parse(t),i=JSON.parse(a.message);window.AgoraRtcAdapter.messageListener(e,i.dataType,i.data)}sendData(e,t,a){return console.log("BW75 sendData ",e,t,a),sendDataGuaranteed(e,t,a)}sendDataGuaranteed(e,t,a){this.agoraRTM?this.sendAgoraRTM(t,a):this.broadcastDataGuaranteed(t,a)}broadcastData(e,t){return this.broadcastDataGuaranteed(e,t)}async sendAgoraRTM(e,t){let a=JSON.stringify({dataType:e,data:t});if(this.agoraRTM2)if(null!=this.rtmClient){const e={type:"text",message:a},t=JSON.stringify(e);try{await this.rtmClient.publish(this.room,t)}catch(e){console.log(e)}}else console.error("uable to send message RTM2 ",e,t);else null!=this.rtmChannel?this.rtmChannel.sendMessage({text:a}).then(()=>{console.log("BW75 broadcastDataGuaranteed sent ",e,t)}).catch(e=>{console.error("AgoraRTM send failure for rtmChannel",e)}):console.error("uable to send message RTM1 ",e,t)}broadcastDataGuaranteed(e,t){if(this.agoraRTM)this.sendAgoraRTM(e,t);else{var a={targetRoom:this.room};this.easyrtc.sendDataWS(a,e,t)}}getConnectStatus(e){console.error("BW73 getConnectStatus ",e);var t=this.easyrtc.getConnectStatus(e);return t==this.easyrtc.IS_CONNECTED?NAF.adapters.IS_CONNECTED:t==this.easyrtc.NOT_CONNECTED?NAF.adapters.NOT_CONNECTED:NAF.adapters.CONNECTING}getMediaStream(e,t="audio"){if(console.log("BW73 getMediaStream ",e,t),this.mediaStreams[e]&&this.mediaStreams[e][t])return NAF.log.write(`Already had ${t} for ${e}`),Promise.resolve(this.mediaStreams[e][t]);{if(NAF.log.write(`Waiting on ${t} for ${e}`),!this.pendingMediaRequests.has(e)){const t={},a=new Promise((e,a)=>{t.audio={resolve:e,reject:a}}).catch(t=>NAF.log.warn(e+" getMediaStream Audio Error",t));t.audio.promise=a;const i=new Promise((e,a)=>{t.video={resolve:e,reject:a}}).catch(t=>NAF.log.warn(e+" getMediaStream Video Error",t));t.video.promise=i,this.pendingMediaRequests.set(e,t)}const a=this.pendingMediaRequests.get(e);if(!a[t]){const i=new Promise((e,i)=>{a[t]={resolve:e,reject:i}}).catch(a=>NAF.log.warn(`${e} getMediaStream "${t}" Error`,a));a[t].promise=i}return this.pendingMediaRequests.get(e)[t].promise}}setMediaStream(e,t,a){console.log("BW73 setMediaStream ",e,t,a);const i=this.pendingMediaRequests.get(e),s=this.mediaStreams[e]=this.mediaStreams[e]||{};if("default"===a){const a=t.getAudioTracks();if(a.length>0){const t=new MediaStream;try{a.forEach(e=>t.addTrack(e)),s.audio=t}catch(t){NAF.log.warn(e+' setMediaStream "audio" alias Error',t)}i&&i.audio.resolve(t)}const o=t.getVideoTracks();if(o.length>0){const t=new MediaStream;try{o.forEach(e=>t.addTrack(e)),s.video=t}catch(t){NAF.log.warn(e+' setMediaStream "video" alias Error',t)}i&&i.video.resolve(t)}}else s[a]=t,i&&i[a]&&i[a].resolve(t)}getIntBytes(e){var t=[],a=this.CustomDatLengthByteCount;do{t[--a]=255&e,e>>=8}while(a);return t}addLocalMediaStream(e,t){console.log("BW73 addLocalMediaStream ",e,t);const a=this.easyrtc;t=t||e.id,this.setMediaStream("local",e,t),a.register3rdPartyLocalMediaStream(e,t),Object.keys(this.remoteClients).forEach(e=>{a.getConnectStatus(e)!==a.NOT_CONNECTED&&a.addStreamToCall(e,t)})}removeLocalMediaStream(e){console.log("BW73 removeLocalMediaStream ",e),this.easyrtc.closeLocalMediaStream(e),delete this.mediaStreams.local[e]}enableMicrophone(e){console.log("BW73 enableMicrophone ",e),this.easyrtc.enableMicrophone(e)}enableCamera(e){console.log("BW73 enableCamera ",e),this.easyrtc.enableCamera(e)}disconnect(){console.log("BW73 disconnect "),this.easyrtc.disconnect()}async handleUserPublished(e,t){}handleUserUnpublished(e,t){console.log("BW73 handleUserUnPublished ")}getInputLevel(e){var t=e._source.volumeLevelAnalyser.analyserNode;const a=t.frequencyBinCount;var i=new Uint8Array(a);t.getByteFrequencyData(i);for(var s=0,o=i.length,r=0;r<o;r++)s+=i[r];return Math.floor(s/o)}generateId(e){let t="";const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=a.length;let s=0;for(;s<e;)t+=a.charAt(Math.floor(Math.random()*i)),s+=1;return t}voiceActivityDetection(){if(this._vad_audioTrack&&this._vad_audioTrack._enabled){var e=this.getInputLevel(this._vad_audioTrack);if(e<=this._vad_MaxBackgroundNoiseLevel){if(this._vad_audioSamplesArr.length>=this._vad_MaxAudioSamples){var t=this._vad_audioSamplesArr.shift(),a=this._vad_audioSamplesArrSorted.indexOf(t);a>-1&&this._vad_audioSamplesArrSorted.splice(a,1)}this._vad_audioSamplesArr.push(e),this._vad_audioSamplesArrSorted.push(e),this._vad_audioSamplesArrSorted.sort((e,t)=>e-t)}e>Math.floor(3*this._vad_audioSamplesArrSorted[Math.floor(this._vad_audioSamplesArrSorted.length/2)]/2)+this._vad_SilenceOffeset?this._vad_exceedCount++:this._vad_exceedCount=0,this._vad_exceedCount>this._vad_exceedCountThresholdLow&&(window._state_stop_at=Date.now()),this._vad_exceedCount>this._vad_exceedCountThreshold&&(this._vad_exceedCount=0,window._state_stop_at=Date.now())}}async connectAgora(e,t){var a=this;if(this.agoraClient=AgoraRTC.createClient({mode:"live",codec:"vp8"}),AgoraRTC.setParameter("SYNC_GROUP",!1),setInterval(()=>{this.readStats()},1e3),(this.enableVideoFiltered||this.enableVideo||this.enableAudio)&&this.agoraClient.setClientRole("host"),this.agoraClient.on("user-joined",async e=>{if(this.agoraRTM&&!this.agoraRTM2){console.error("user-joined",e.uid,this.occupantList),this.occupantList[e.uid]=e.uid;let t=JSON.parse(JSON.stringify(this.occupantList));this.occupantListener(t)}}),this.agoraClient.on("user-left",async e=>{if(this.agoraRTM&&!this.agoraRTM2){console.error("user-left",e.uid,this.occupantList),delete this.occupantList[e.uid];let t=JSON.parse(JSON.stringify(this.occupantList));this.occupantListener(t)}}),this.agoraClient.on("user-published",async(e,t)=>{let i=e.uid;console.log("BW73 handleUserPublished "+i+" "+t,a.agoraClient),await a.agoraClient.subscribe(e,t),console.log("BW73 handleUserPublished2 "+i+" "+a.agoraClient);const s=a.pendingMediaRequests.get(i),o=a.mediaStreams[i]=a.mediaStreams[i]||{};if("audio"===t){e.audioTrack.play();const t=new MediaStream;console.log("user.audioTrack ",e.audioTrack._mediaStreamTrack),t.addTrack(e.audioTrack._mediaStreamTrack),o.audio=t,s&&s.audio.resolve(t)}let r=null;"video"===t&&(r=new MediaStream,console.log("user.videoTrack ",e.videoTrack._mediaStreamTrack),r.addTrack(e.videoTrack._mediaStreamTrack),o.video=r,s&&s.video.resolve(r)),"CCC"==i&&("video"===t&&(document.querySelector("#video360").srcObject=r,document.querySelector("#video360").play()),"audio"===t&&e.audioTrack.play()),"DDD"==i&&("video"===t&&e.videoTrack.play("video360"),"audio"===t&&e.audioTrack.play());let n="na";"audio"===t&&(n=e.audioTrack._mediaStreamTrack.id);const c=this.agoraClient._p2pChannel.connection.peerConnection.getReceivers();for(let e=0;e<c.length;e++)c[e].track&&c[e].track.id===n&&this.createDecoder(c[e],i)}),this.agoraClient.on("user-unpublished",a.handleUserUnpublished),console.log("connect agora "+this.clientId),this.enableAvatar){var i=document.getElementById("canvas").captureStream(30);[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCustomVideoTrack({mediaStreamTrack:i.getVideoTracks()[0]})])}else if(this.enableVideoFiltered&&this.enableAudio){i=document.getElementById("canvas_secret").captureStream(30);[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCustomVideoTrack({mediaStreamTrack:i.getVideoTracks()[0]})])}else if(this.enableVideo&&this.enableAudio)[this.userid,this.localTracks.audioTrack,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createMicrophoneAudioTrack(),AgoraRTC.createCameraVideoTrack({encoderConfig:"480p_2"})]);else if(this.enableVideo)[this.userid,this.localTracks.videoTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),AgoraRTC.createCameraVideoTrack("360p_4")]);else if(this.enableAudio){let e;e=window.gum_stream?AgoraRTC.createCustomAudioTrack({mediaStreamTrack:window.gum_stream.getAudioTracks()[0]}):AgoraRTC.createMicrophoneAudioTrack(),[this.userid,this.localTracks.audioTrack]=await Promise.all([this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null),e]),this._vad_audioTrack=this.localTracks.audioTrack,this._voiceActivityDetectionInterval||(this._voiceActivityDetectionInterval=setInterval(()=>{this.voiceActivityDetection()},this._voiceActivityDetectionFrequency))}else this.userid=await this.agoraClient.join(this.appid,this.room,this.token||null,this.clientId||null);if(this.enableVideo&&!this.enableVideoFiltered){let e=await AgoraRTC.getCameras();for(var s=0;s<e.length;s++)0==e[s].label.indexOf("FaceTime")&&(console.log("select FaceTime camera",e[s].deviceId),await this.localTracks.videoTrack.setDevice(e[s].deviceId))}if(this.enableVideo&&this.showLocal&&this.localTracks.videoTrack.play("local-player"),this.enableVideo&&this.vbg0&&this.localTracks.videoTrack){const e=document.createElement("img");e.onload=async()=>{this.virtualBackgroundInstance||(console.log("SEG INIT ",this.localTracks.videoTrack),this.virtualBackgroundInstance=await SegPlugin.inject(this.localTracks.videoTrack,"/assets/wasms0").catch(console.error),console.log("SEG INITED")),this.virtualBackgroundInstance.setOptions({enable:!0,background:e})},e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAIAAAA7ljmRAAAAD0lEQVR4XmNg+M+AQDg5AOk9C/VkomzYAAAAAElFTkSuQmCC"}if(this.enableVideo&&this.vbg&&this.localTracks.videoTrack&&(this.extension=new VirtualBackgroundExtension,AgoraRTC.registerExtensions([this.extension]),this.processor=this.extension.createProcessor(),await this.processor.init("/assets/wasms"),this.localTracks.videoTrack.pipe(this.processor).pipe(this.localTracks.videoTrack.processorDestination),await this.processor.setOptions({type:"color",color:"#00ff00"}),await this.processor.enable()),window.localTracks=this.localTracks,this.enableVideo||this.enableAudio||this.enableAvatar){this.localTracks.audioTrack&&await this.agoraClient.publish(this.localTracks.audioTrack),this.localTracks.videoTrack&&await this.agoraClient.publish(this.localTracks.videoTrack),console.log("publish success");const e=this.agoraClient._p2pChannel.connection.peerConnection.getSenders();let t=0;for(t=0;t<e.length;t++)e[t].track&&"audio"==e[t].track.kind&&this.createEncoder(e[t])}if(this.agoraRTM)if(null==this.clientId&&(this.clientId="X"+this.userid),this.rtmUid=this.clientId,this.agoraRTM2){AgoraRTM.setArea({areaCodes:["GLOBAL"]}),this.rtmClient=new AgoraRTM.RTM(this.appid,this.rtmUid,{presenceTimeout:5}),this.rtmClient.addEventListener({message:e=>{window.AgoraRtcAdapter.handleRTM2(e.publisher,e.message)},presence:e=>{if("SNAPSHOT"===e.eventType)for(let t=0;t<e.snapshot.length;t++){let a=this.occupantList[e.snapshot[t].userId];this.occupantList[e.snapshot[t].userId]=e.snapshot[t].userId;let i=JSON.parse(JSON.stringify(this.occupantList));this.occupantListener(i),a||this.openListener(e.snapshot[t].userId)}else if("REMOTE_JOIN"===e.eventType){let t=this.occupantList[e.publisher];this.occupantList[e.publisher]=e.publisher;let a=JSON.parse(JSON.stringify(this.occupantList));this.occupantListener(a),t||this.openListener(e.publisher)}else if("REMOTE_TIMEOUT"===e.eventType||"REMOTE_LEAVE"===e.eventType){delete this.occupantList[e.publisher];let t=JSON.parse(JSON.stringify(this.occupantList));this.occupantListener(t)}}}),window.addEventListener("beforeunload",()=>{window.AgoraRtcAdapter.rtmClient.logout()});try{const t=await this.rtmClient.login();await this.rtmClient.subscribe(this.room),console.log("rtm LOGIN SUCCESS for: "+this.rtmUid,t),e(this.clientId)}catch(e){console.error("rtm LOGIN FAILED for: "+this.rtmUid,e)}}else this.rtmClient=AgoraRTM.createInstance(this.appid,{logFilter:AgoraRTM.LOG_FILTER_OFF}),this.rtmClient.on("ConnectionStateChanged",(e,t)=>{console.log("this.rtmClient connection state changed to "+e+" reason: "+t)}),this.rtmClient.on("MessageFromPeer",({text:e},t)=>{this.handleRTM(t,e)}),this.rtmClient.login({token:null,uid:this.rtmUid}).then(()=>{this.rtmChannel=this.rtmClient.createChannel(this.room),this.rtmChannel.on("MemberJoined",e=>{}),this.rtmChannel.on("MemberLeft",e=>{}),this.rtmChannel.join().then(()=>{this.rtmChannel.on("ChannelMessage",({text:e},t)=>{this.handleRTM(t,e)}),e(this.clientId)}).catch(e=>{console.log("AgoraRTM client join failure",e)})}).catch(e=>{console.log("AgoraRTM client login failure",e)})}async _connect(e,t){await this.easyrtc.connect(this.app,e,t)}_getRoomJoinTime(e){var t=this.room;return this.easyrtc.getRoomOccupantsAsMap(t)[e].roomJoinTime}getServerTime(){return Date.now()+this.avgTimeOffset}}NAF.adapters.register("agorartc",a),e.exports=a}]);
//# sourceMappingURL=naf-agora-adapter.min.js.map